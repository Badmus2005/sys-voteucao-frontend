<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin UCAO</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="dashboard.css"/>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img id="adminPhoto"
                    src="https://img.freepik.com/photos-premium/photo-etudiant-i-image-etudiant-i-etudiants-souriants-i-etudiant-universitaire-i-etudiants-collage_403587-2980.jpg"
                    alt="Photo Admin"
                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGRkYiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iIzAwMCI+QWRtaW48L3RleHQ+PC9zdmc+'">
                <h3 id="adminName">Admin UCAO</h3>
                <p id="adminEmail">superadmin@ucao-uuc.com</p>
                <span class="admin-badge" id="adminRole">Administrateur</span>
            </div>
            <ul class="sidebar-menu">
                <h3>Général</h3>
                <li class="active"><a href="#" id="navDashboard"><i class="fas fa-tachometer-alt"></i> Tableau de Bord</a></li>
                <li><a href="#" id="navUsers"><i class="fas fa-users"></i> Utilisateurs</a></li>
                <li><a href="#" id="navCandidates"><i class="fas fa-user"></i> Candidats</a></li>
                <li><a href="#" id="navStats"><i class="fas fa-chart-pie"></i> Statistiques</a></li>
                <h3>Administration</h3>
                <li><a href="#" id="profileNavBtn"><i class="fas fa-user-cog"></i> Modifier Profil</a></li>
                <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- DASHBOARD SECTION -->
            <section id="dashboardSection">
                <div class="admin-header">
                    <h1><i class="fas fa-tachometer-alt"></i> Tableau de Bord</h1>
                    <div class="admin-actions">
                        <a href="#" class="alert-btn" aria-label="Notifications"><i class="fas fa-bell"></i></a>
                        <a href="#" aria-label="Messages"><i class="fas fa-envelope"></i></a>
                        <a href="#" aria-label="Aide"><i class="fas fa-question-circle"></i></a>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="admin-stats">
                    <div class="admin-card">
                        <h3><i class="fas fa-user-check"></i> Utilisateurs Actifs</h3>
                        <p id="totalUsers">0</p>
                        <small>+0% ce mois</small>
                        <div class="progress-bar">
                            <div class="progress" id="usersProgress"></div>
                        </div>
                    </div>
                    <div class="admin-card">
                        <h3><i class="fas fa-vote-yea"></i> Votes Effectués</h3>
                        <p id="totalVotes">0</p>
                        <small>+0% aujourd'hui</small>
                        <div class="progress-bar">
                            <div class="progress" id="votesProgress"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="activity-section">
                    <h2><i class="fas fa-history"></i> Activité Récentes</h2>
                    <div id="activityList"></div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions-section">
                    <h2 class="quick-actions-title"><i class="fas fa-bolt"></i> Actions Rapides</h2>
                    <div class="quick-actions">
                        <div class="action-card" id="addElection">
                            <i class="fas fa-plus-circle"></i>
                            <h3>Ajouter Élection</h3>
                            <p>Créer une nouvelle élection</p>
                        </div>
                        <div class="action-card" id="importMatricules">
                            <i class="fas fa-file-import"></i>
                            <h3>Importer Matricules</h3>
                            <p>Importer des matricules depuis un fichier</p>
                        </div>
                    </div>
                </div>

                <!-- Code Generation -->
                <div class="generation-section" id="generation-section">
                    <h2><i class="fas fa-key"></i> Générer des codes</h2>
                    <div class="input-group">
                        <input type="number" id="codeCountInput" placeholder="Nombre de codes (1-100)" min="1" max="100">
                        <button id="generateBtn" class="btn-primary pulse-on-hover">
                            <i class="fas fa-bolt"></i> Générer
                        </button>
                    </div>
                </div>

                <div id="resultsSection" class="generated-codes-section" style="display:none;">
                    <h3 class="codes-title">Codes générés <span id="codesCount" class="codes-count"></span></h3>
                    <div class="codes-actions">
                        <button id="copyAllBtn" class="action-btn copy-btn">
                            <i class="fas fa-copy"></i> Copier tous
                        </button>
                        <button id="downloadBtn" class="action-btn download-btn">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                    </div>
                    <div id="codesContainer" class="codes-grid"></div>
                </div>
            </section>

            <!-- PROFILE SECTION -->
            <section id="profileSection" class="profile-section" style="display:none;">
                <div class="profile-header">
                    <h2><i class="fas fa-user-cog"></i> Modifier Profil</h2>
                    <button id="closeProfileBtn" class="close-btn" aria-label="Fermer">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="profile-content">
                    <div class="profile-card">
                        <div class="profile-photo-container">
                            <img id="currentPhoto" src="https://via.placeholder.com/150" alt="Photo de profil" class="profile-photo">
                            <div class="profile-badge">ADMIN</div>
                        </div>
                        <div class="profile-info">
                            <h2 id="displayName">Nom Utilisateur</h2>
                            <p id="displayEmail">email@exemple.com</p>
                        </div>
                    </div>

                    <div class="edit-profile-form">
                        <div class="form-group">
                            <label for="inputNom"><i class="fas fa-user-tag"></i> Nom:</label>
                            <input type="text" id="inputNom" placeholder="Votre nom">
                        </div>

                        <div class="form-group">
                            <label for="inputPrenom"><i class="fas fa-user"></i> Prénom:</label>
                            <input type="text" id="inputPrenom" placeholder="Votre prénom">
                        </div>

                        <div class="form-group">
                            <label for="inputEmail"><i class="fas fa-envelope"></i> Email:</label>
                            <input type="email" id="inputEmail" disabled>
                        </div>

                        <div class="photo-upload-section">
                            <h3><i class="fas fa-camera"></i> Photo de Profil</h3>
                            <div class="upload-container">
                                <label for="profilePhotoInput" class="upload-label">
                                    <i class="fas fa-cloud-upload-alt"></i> Choisir une image
                                    <input type="file" id="profilePhotoInput" accept="image/jpeg, image/png, image/webp">
                                </label>
                                <button id="uploadProfilePhotoBtn" class="upload-btn">
                                    <i class="fas fa-upload"></i> Téléverser
                                </button>
                            </div>
                            <p class="file-info">Format JPG/PNG - Max 2MB</p>
                        </div>

                        <div id="updateResult" class="update-result"></div>

                        <button id="saveProfileBtn" class="save-btn">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <!-- Configuration et scripts -->
    <script src="config.js"></script>
    <script>
        // Fonction utilitaire pour gérer les event listeners
        function safeAddListener(id, event, handler) {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener(event, handler);
                return true;
            }
            console.error(`Element #${id} not found`);
            return false;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // ------------ CONFIG ------------
            const API_BASE = CONFIG.API.BASE_URL;
            const FRONTEND_BASE = window.location.origin;
            const ADMIN_ME_ENDPOINT = CONFIG.API.ENDPOINTS.ADMIN.ME;
            const STATS_ENDPOINT = CONFIG.API.ENDPOINTS.STATS.GENERAL;
            const ACTIVITY_ENDPOINT = CONFIG.API.ENDPOINTS.ACTIVITY.LIST;
            const CODES_GENERATE_ENDPOINT = CONFIG.API.ENDPOINTS.CODES.GENERATE;
            const token = localStorage.getItem('adminToken');

            if (!token) {
                showToast('Session expirée, redirection...', 'error');
                setTimeout(() => {
                    window.location.href = `${FRONTEND_BASE}/index.html`;
                }, 2000);
                return;
            }

            // ------------ UTILS ------------
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                if (!toast) return;
                
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            function showLoading() {
                const loader = document.getElementById('loadingOverlay');
                if (loader) loader.classList.add('active');
            }

            function hideLoading() {
                const loader = document.getElementById('loadingOverlay');
                if (loader) loader.classList.remove('active');
            }

            // ------------ NAVIGATION ------------
            const dashboardSection = document.getElementById('dashboardSection');
            const profileSection = document.getElementById('profileSection');

            // Gestion du toggle du profil
            safeAddListener('profileNavBtn', 'click', () => {
                if (profileSection.style.display === 'none' || !profileSection.style.display) {
                    profileSection.style.display = 'block';
                    if (dashboardSection) dashboardSection.style.display = 'none';
                    loadAdminInfo();
                } else {
                    profileSection.style.display = 'none';
                    if (dashboardSection) dashboardSection.style.display = 'block';
                }
            });

            // Bouton de fermeture du profil
            safeAddListener('closeProfileBtn', 'click', () => {
                if (profileSection) profileSection.style.display = 'none';
                if (dashboardSection) dashboardSection.style.display = 'block';
            });

            // Déconnexion
            safeAddListener('logout', 'click', () => {
                localStorage.removeItem('adminToken');
                window.location.href = `${FRONTEND_BASE}/index.html`;
            });

            // ------------ PROFILE MANAGEMENT ------------
            async function loadAdminInfo() {
                try {
                    showLoading();
                    const res = await fetch(`${API_BASE}${ADMIN_ME_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!res.ok) throw new Error('Erreur chargement profil');

                    const admin = await res.json();
                    updateProfileUI(admin);
                } catch (err) {
                    console.error('Erreur chargement info admin:', err);
                    showToast('Erreur de chargement du profil', 'error');
                } finally {
                    hideLoading();
                }
            }

            function updateProfileUI(admin) {
                const elements = {
                    displayName: `${admin.nom || ''} ${admin.prenom || ''}`,
                    displayEmail: admin.email,
                    displayRole: admin.role === 'ADMIN' ? 'Administrateur' : 'Utilisateur',
                    inputNom: admin.nom || '',
                    inputPrenom: admin.prenom || '',
                    inputEmail: admin.email,
                    adminName: `${admin.nom || ''} ${admin.prenom || ''}`,
                    adminEmail: admin.email,
                    adminRole: admin.role === 'ADMIN' ? 'Administrateur' : 'Utilisateur'
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                });

                if (admin.photoUrl) {
                    const currentPhoto = document.getElementById('currentPhoto');
                    const adminPhoto = document.getElementById('adminPhoto');
                    if (currentPhoto) currentPhoto.src = admin.photoUrl + '?t=' + Date.now();
                    if (adminPhoto) adminPhoto.src = admin.photoUrl + '?t=' + Date.now();
                }
            }

            // Sauvegarde du profil
            safeAddListener('saveProfileBtn', 'click', async function() {
                const nom = document.getElementById('inputNom')?.value.trim();
                const prenom = document.getElementById('inputPrenom')?.value.trim();

                if (!nom || !prenom) {
                    showToast('Nom et prénom sont obligatoires', 'error');
                    return;
                }

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/admin/update`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ nom, prenom })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erreur lors de la mise à jour');
                    }

                    showToast('Profil mis à jour avec succès', 'success');
                    updateProfileUI({ nom, prenom });
                } catch (error) {
                    console.error('Erreur:', error);
                    showToast(error.message || 'Erreur lors de la sauvegarde', 'error');
                } finally {
                    hideLoading();
                }
            });

            // Upload de photo
            safeAddListener('uploadProfilePhotoBtn', 'click', async function() {
                const fileInput = document.getElementById('profilePhotoInput');
                if (!fileInput?.files?.length) {
                    showToast('Veuillez sélectionner une photo', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('photo', fileInput.files[0]);

                try {
                    const btn = this;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';

                    const response = await fetch(`${API_BASE}/upload/admin`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erreur lors de l\'upload');
                    }

                    const data = await response.json();
                    const currentPhoto = document.getElementById('currentPhoto');
                    const adminPhoto = document.getElementById('adminPhoto');
                    if (currentPhoto) currentPhoto.src = data.url + '?t=' + Date.now();
                    if (adminPhoto) adminPhoto.src = data.url + '?t=' + Date.now();

                    showToast('Photo mise à jour avec succès', 'success');
                } catch (error) {
                    console.error('Erreur:', error);
                    showToast(error.message || 'Erreur lors de l\'upload', 'error');
                } finally {
                    const btn = document.getElementById('uploadProfilePhotoBtn');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-upload"></i> Téléverser';
                    }
                }
            });

            // ------------ CODE GENERATION ------------
            safeAddListener('generateBtn', 'click', generateCodes);

            async function generateCodes() {
                const countInput = document.getElementById('codeCountInput');
                const count = parseInt(countInput?.value);

                if (!count || count < 1 || count > 100) {
                    showToast('Veuillez entrer un nombre entre 1 et 100', 'error');
                    return;
                }

                const generateBtn = document.getElementById('generateBtn');
                if (!generateBtn) return;

                const originalBtnText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
                generateBtn.disabled = true;

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}${CODES_GENERATE_ENDPOINT}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ quantity: count })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Erreur lors de la génération');

                    displayGeneratedCodes(data.codes);
                    showToast(`${data.codes.length} codes générés avec succès`, 'success');
                } catch (error) {
                    console.error('Erreur génération codes:', error);
                    showToast(error.message || 'Échec de la génération', 'error');
                } finally {
                    generateBtn.innerHTML = originalBtnText;
                    generateBtn.disabled = false;
                    hideLoading();
                }
            }

            function displayGeneratedCodes(codes) {
                const container = document.getElementById('codesContainer');
                const resultsSection = document.getElementById('resultsSection');
                if (!container || !resultsSection) return;

                container.innerHTML = '';
                codes.forEach(code => {
                    const codeElement = document.createElement('div');
                    codeElement.className = 'code-item';
                    codeElement.innerHTML = `
                        <span>${code}</span>
                        <button class="copy-single-btn" data-code="${code}">
                            <i class="fas fa-copy"></i>
                        </button>
                    `;
                    container.appendChild(codeElement);
                });

                document.querySelectorAll('.copy-single-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const code = this.getAttribute('data-code');
                        navigator.clipboard.writeText(code)
                            .then(() => {
                                this.innerHTML = '<i class="fas fa-check" style="color:green;"></i>';
                                setTimeout(() => {
                                    this.innerHTML = '<i class="fas fa-copy"></i>';
                                }, 2000);
                            });
                    });
                });

                resultsSection.style.display = 'block';
                const codesCount = document.getElementById('codesCount');
                if (codesCount) codesCount.textContent = `(${codes.length} codes)`;
                resultsSection.style.animation = 'fadeIn 0.3s ease-out';
            }

            safeAddListener('copyAllBtn', 'click', () => {
                const codes = Array.from(document.querySelectorAll('.code-item span'))
                    .map(el => el.textContent)
                    .join('\n');

                navigator.clipboard.writeText(codes)
                    .then(() => {
                        const copyBtn = document.getElementById('copyAllBtn');
                        if (!copyBtn) return;
                        
                        const originalHtml = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHtml;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Erreur copie:', err);
                        showToast('Erreur lors de la copie', 'error');
                    });
            });

            safeAddListener('downloadBtn', 'click', () => {
                const codes = Array.from(document.querySelectorAll('.code-item span'))
                    .map(el => el.textContent)
                    .join('\n');

                const blob = new Blob([codes], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `codes-ucao-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Vérification du rôle admin
            if (token) {
                try {
                    const response = await fetch(`${API_BASE}${ADMIN_ME_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const user = await response.json();
                    
                    if (user.role !== 'ADMIN') {
                        const genSection = document.getElementById('generation-section');
                        if (genSection) genSection.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Erreur vérification rôle:', error);
                }
            }

            // ------------ DASHBOARD DATA ------------
            async function loadStats() {
                try {
                    const res = await fetch(`${API_BASE}${STATS_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();

                    const totalUsers = document.getElementById('totalUsers');
                    const totalVotes = document.getElementById('totalVotes');
                    const usersProgress = document.getElementById('usersProgress');
                    const votesProgress = document.getElementById('votesProgress');

                    if (totalUsers) totalUsers.textContent = data.users?.total || 0;
                    if (totalVotes) totalVotes.textContent = data.votes?.total || 0;
                    if (usersProgress) usersProgress.style.width = (data.users?.percent || 0) + '%';
                    if (votesProgress) votesProgress.style.width = (data.votes?.percent || 0) + '%';
                } catch (err) {
                    console.error('Erreur chargement stats:', err);
                }
            }

            async function loadActivity() {
                try {
                    const res = await fetch(`${API_BASE}${ACTIVITY_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const activities = await res.json();
                    const container = document.getElementById('activityList');
                    if (!container) return;

                    container.innerHTML = '';
                    activities.forEach(act => {
                        const div = document.createElement('div');
                        div.classList.add('activity-item');
                        div.innerHTML = `
                            <div class="activity-icon"><i class="fas fa-check"></i></div>
                            <div class="activity-content">
                                <h4>${act.title}</h4>
                                <p>${act.content}</p>
                            </div>
                            <div class="activity-time">${act.time}</div>
                        `;
                        container.appendChild(div);
                    });
                } catch (err) {
                    console.error('Erreur chargement activités:', err);
                }
            }

            // ------------ INITIAL LOAD ------------
            loadAdminInfo();
            loadStats();
            loadActivity();
        });
    </script>
</body>
</html>