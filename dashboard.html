<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin UCAO</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="./dashboard.css">
   
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img id="adminPhoto"
                    src="https://img.freepik.com/photos-premium/photo-etudiant-i-image-etudiant-i-etudiants-souriants-i-etudiant-universitaire-i-etudiants-collage_403587-2980.jpg"
                    alt="Photo Admin"
                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMjAwIDIwMCI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNGRkYiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iIzAwMCI+QWRtaW48L3RleHQ+PC9zdmc+'">
                <h3 id="adminName">Admin UCAO</h3>
                <p id="adminEmail">superadmin@ucao-uuc.com</p>
                <span class="admin-badge" id="adminRole">Administrateur</span>
            </div>
            <ul class="sidebar-menu">
                <h3>Général</h3>
                <li class="active"><a href="#" id="navDashboard"><i class="fas fa-tachometer-alt"></i> Tableau de
                        Bord</a></li>
                <li><a href="#" id="navUsers"><i class="fas fa-users"></i> Utilisateurs</a></li>
                <li><a href="#" id="navCandidates"><i class="fas fa-user"></i> Candidats</a></li>
                <li><a href="#" id="navStats"><i class="fas fa-chart-pie"></i> Statistiques</a></li>
                <h3>Administration</h3>
                <li><a href="#" id="profileNavBtn"><i class="fas fa-user-cog"></i> Modifier Profil</a></li>
                <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- DASHBOARD SECTION -->
            <section id="dashboardSection">
                <!-- Contenu existant inchangé -->
            </section>

            <!-- PROFILE SECTION -->
            <section id="profileSection" class="profile-section" style="display:none;">
                <!-- Contenu existant inchangé -->
            </section>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <!-- Configuration et scripts -->
    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // ------------ CONFIG ------------
            const API_BASE = CONFIG.API.BASE_URL;
            const FRONTEND_BASE = window.location.origin;
            const ADMIN_ME_ENDPOINT = CONFIG.API.ENDPOINTS.ADMIN.ME;
            const STATS_ENDPOINT = CONFIG.API.ENDPOINTS.STATS.GENERAL;
            const ACTIVITY_ENDPOINT = CONFIG.API.ENDPOINTS.ACTIVITY.LIST;
            const CODES_GENERATE_ENDPOINT = CONFIG.API.ENDPOINTS.CODES.GENERATE;
            const token = localStorage.getItem('adminToken');

            if (!token) {
                showToast('Session expirée, redirection...', 'error');
                setTimeout(() => {
                    window.location.href = `${FRONTEND_BASE}/index.html`;
                }, 2000);
                return;
            }

            // ------------ UTILS ------------
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            function showLoading() {
                document.getElementById('loadingOverlay').classList.add('active');
            }

            function hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('active');
            }

            // ------------ NAVIGATION ------------
            const dashboardSection = document.getElementById('dashboardSection');
            const profileSection = document.getElementById('profileSection');
            const profileNavBtn = document.getElementById('profileNavBtn');

            profileNavBtn.addEventListener('click', () => {
                toggleProfileSection();
            });

            function toggleProfileSection() {
                if (profileSection.style.display === 'none' || !profileSection.style.display) {
                    profileSection.style.display = 'block';
                    dashboardSection.style.display = 'none';
                    loadAdminInfo();
                } else {
                    profileSection.style.display = 'none';
                    dashboardSection.style.display = 'block';
                }
            }

            document.getElementById('closeProfileBtn').addEventListener('click', () => {
                profileSection.style.display = 'none';
                dashboardSection.style.display = 'block';
            });

            // ------------ LOGOUT ------------
            document.getElementById('logout').addEventListener('click', () => {
                localStorage.removeItem('adminToken');
                window.location.href = `${FRONTEND_BASE}/index.html`;
            });

            // ------------ PROFILE MANAGEMENT ------------
            async function loadAdminInfo() {
                try {
                    showLoading();
                    const res = await fetch(`${API_BASE}${ADMIN_ME_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!res.ok) throw new Error('Erreur chargement profil');

                    const admin = await res.json();

                    // Mise à jour de l'UI
                    updateProfileUI(admin);
                } catch (err) {
                    console.error('Erreur chargement info admin:', err);
                    showToast('Erreur de chargement du profil', 'error');
                } finally {
                    hideLoading();
                }
            }

            function updateProfileUI(admin) {
                const elements = {
                    displayName: `${admin.nom || ''} ${admin.prenom || ''}`,
                    displayEmail: admin.email,
                    displayRole: admin.role === 'ADMIN' ? 'Administrateur' : 'Utilisateur',
                    inputNom: admin.nom || '',
                    inputPrenom: admin.prenom || '',
                    inputEmail: admin.email,
                    adminName: `${admin.nom || ''} ${admin.prenom || ''}`,
                    adminEmail: admin.email,
                    adminRole: admin.role === 'ADMIN' ? 'Administrateur' : 'Utilisateur'
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                });

                if (admin.photoUrl) {
                    document.getElementById('currentPhoto').src = admin.photoUrl + '?t=' + Date.now();
                    document.getElementById('adminPhoto').src = admin.photoUrl + '?t=' + Date.now();
                }
            }

            // ------------ SAVE PROFILE ------------
            document.getElementById('saveProfileBtn').addEventListener('click', async function () {
                const nom = document.getElementById('inputNom').value.trim();
                const prenom = document.getElementById('inputPrenom').value.trim();
                const updateResult = document.getElementById('updateResult');

                if (!nom || !prenom) {
                    showToast('Nom et prénom sont obligatoires', 'error');
                    return;
                }

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}/admin/update`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ nom, prenom })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erreur lors de la mise à jour');
                    }

                    showToast('Profil mis à jour avec succès', 'success');
                    updateProfileUI({ nom, prenom });
                } catch (error) {
                    console.error('Erreur:', error);
                    showToast(error.message || 'Erreur lors de la sauvegarde', 'error');
                } finally {
                    hideLoading();
                }
            });

            // ------------ CODE GENERATION ------------
            document.getElementById('generateBtn').addEventListener('click', generateCodes);

            async function generateCodes() {
                const countInput = document.getElementById('codeCountInput');
                const count = parseInt(countInput.value);

                if (!count || count < 1 || count > 100) {
                    showToast('Veuillez entrer un nombre entre 1 et 100', 'error');
                    return;
                }

                const generateBtn = document.getElementById('generateBtn');
                const originalBtnText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Génération...';
                generateBtn.disabled = true;

                try {
                    showLoading();
                    const response = await fetch(`${API_BASE}${CODES_GENERATE_ENDPOINT}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ quantity: count })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Erreur lors de la génération');

                    displayGeneratedCodes(data.codes);
                    showToast(`${data.codes.length} codes générés avec succès`, 'success');
                } catch (error) {
                    console.error('Erreur génération codes:', error);
                    showToast(error.message || 'Échec de la génération', 'error');
                } finally {
                    generateBtn.innerHTML = originalBtnText;
                    generateBtn.disabled = false;
                    hideLoading();
                }
            }

            // Affiche les codes générés 
            function displayGeneratedCodes(codes) {
                const container = document.getElementById('codesContainer');
                const resultsSection = document.getElementById('resultsSection');

                // Effacer le contenu précédent
                container.innerHTML = '';

                // Ajouter chaque code
                codes.forEach(code => {
                    const codeElement = document.createElement('div');
                    codeElement.className = 'code-item';
                    codeElement.innerHTML = `
            <span>${code}</span>
            <button class="copy-single-btn" data-code="${code}">
                <i class="fas fa-copy"></i>
            </button>
        `;
                    container.appendChild(codeElement);
                });

                // Activer les boutons de copie individuels
                document.querySelectorAll('.copy-single-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const code = this.getAttribute('data-code');
                        navigator.clipboard.writeText(code)
                            .then(() => {
                                this.innerHTML = '<i class="fas fa-check" style="color:green;"></i>';
                                setTimeout(() => {
                                    this.innerHTML = '<i class="fas fa-copy"></i>';
                                }, 2000);
                            });
                    });
                });

                // Afficher la section
                resultsSection.style.display = 'block';

                // Mettre à jour le compteur
                document.getElementById('codesCount').textContent = `(${codes.length} codes)`;

                // Animation d'apparition
                resultsSection.style.animation = 'fadeIn 0.3s ease-out';
            }

            // Bouton Copier tous les codes (version optimisée)
            document.getElementById('copyAllBtn').addEventListener('click', () => {
                const codes = Array.from(document.querySelectorAll('.code-item span'))
                    .map(el => el.textContent)
                    .join('\n');

                navigator.clipboard.writeText(codes)
                    .then(() => {
                        const copyBtn = document.getElementById('copyAllBtn');
                        const originalHtml = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copié !';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHtml;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Erreur copie:', err);
                        alert('Erreur lors de la copie');
                    });
            });

            // Bouton Télécharger (version compatible)
            document.getElementById('downloadBtn').addEventListener('click', () => {
                const codes = Array.from(document.querySelectorAll('.code-item span'))
                    .map(el => el.textContent)
                    .join('\n');

                const blob = new Blob([codes], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `codes-ucao-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Vérification du rôle admin au chargement
            document.addEventListener('DOMContentLoaded', () => {
                if (token) {
                    fetch(`${API_BASE}${ADMIN_ME_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                        .then(response => response.json())
                        .then(user => {
                            if (user.role !== 'ADMIN') {
                                document.getElementById('generation-section').style.display = 'none';
                            }
                        })
                        .catch(console.error);
                }
            });
            // ------------ DASHBOARD DATA ------------
            async function loadStats() {
                try {
                    const res = await fetch(`${API_BASE}${STATS_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();

                    document.getElementById('totalUsers').textContent = data.users?.total || 0;
                    document.getElementById('totalVotes').textContent = data.votes?.total || 0;
                    document.getElementById('usersProgress').style.width = (data.users?.percent || 0) + '%';
                    document.getElementById('votesProgress').style.width = (data.votes?.percent || 0) + '%';
                } catch (err) {
                    console.error('Erreur chargement stats:', err);
                }
            }

            async function loadActivity() {
                try {
                    const res = await fetch(`${API_BASE}${ACTIVITY_ENDPOINT}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const activities = await res.json();
                    const container = document.getElementById('activityList');

                    container.innerHTML = '';
                    activities.forEach(act => {
                        const div = document.createElement('div');
                        div.classList.add('activity-item');
                        div.innerHTML = `
                        <div class="activity-icon"><i class="fas fa-check"></i></div>
                        <div class="activity-content">
                            <h4>${act.title}</h4>
                            <p>${act.content}</p>
                        </div>
                        <div class="activity-time">${act.time}</div>
                    `;
                        container.appendChild(div);
                    });
                } catch (err) {
                    console.error('Erreur chargement activités:', err);
                }
            }

            // ------------ INITIAL LOAD ------------
            loadAdminInfo();
            loadStats();
            loadActivity();
        });
    </script>
</body>

</html>