<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidature - UCAO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #800020;
            --primary-dark: #5a0017;
            --secondary: #0d1b2a;
            --accent: #d4af37;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f8fafc;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 80px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            min-height: 100vh;
        }

        /* Header */
        .main-header {
            grid-area: header;
            background: white;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: sticky;
            top: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            margin-left: auto;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-btn:hover {
            color: var(--primary);
            background-color: rgba(128, 0, 32, 0.05);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: var(--gray-light);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            z-index: 20;
            height: 100vh;
            position: fixed;
            width: 280px;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-light);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-menu {
            flex: 1;
            padding: 2rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.9rem 1.5rem;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(128, 0, 32, 0.05);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .nav-icon {
            width: 24px;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        .nav-text {
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-light);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem;
            background: none;
            border: none;
            color: var(--danger);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 6px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Main Content */
        .main-content {
            grid-area: main;
            padding: 2rem;
            overflow-y: auto;
            background-color: #f8fafc;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--gray);
            animation: fadeIn 0.5s ease-out;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .breadcrumb a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* State Messages */
        .state-message,
        .status-message {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .state-icon,
        .status-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .state-title,
        .status-title {
            color: var(--secondary);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .state-description,
        .status-description {
            color: var(--gray);
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        .state-actions,
        .status-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: var(--gray);
            color: white;
        }

        /* Candidature Header */
        .candidature-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease-out;
        }

        .candidature-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .candidature-subtitle {
            opacity: 0.9;
        }

        /* Loading State */
        .loading-state {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            animation: fadeInUp 0.5s ease-out;
        }

        .loading-state .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Eligibility Alert */
        .eligibility-alert {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--danger);
            animation: fadeInUp 0.5s ease-out;
        }

        .alert-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .alert-description {
            margin-bottom: 1.25rem;
            color: var(--gray);
        }

        .alert-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Form Section */
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: fadeInUp 0.5s ease-out;
        }

        .form-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--secondary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-light);
            font-size: 1.25rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--secondary);
            font-size: 0.95rem;
        }

        .form-label.required:after {
            content: " *";
            color: var(--danger);
        }

        .form-input,
        .form-textarea {
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-help {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.3rem;
        }

        /* Image Upload */
        .image-upload {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .upload-area {
            border: 2px dashed var(--gray-light);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary);
            background-color: rgba(128, 0, 32, 0.05);
        }

        .upload-icon {
            font-size: 1.75rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .upload-text {
            font-weight: 500;
            margin-bottom: 0.3rem;
            color: var(--dark);
        }

        .upload-hint {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .upload-preview {
            display: none;
            position: relative;
            max-width: 200px;
            margin: 0 auto;
        }

        .preview-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .remove-image:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-light);
        }

        /* Candidates Section */
        .candidates-section {
            margin-top: 2rem;
            animation: fadeInUp 0.5s ease-out;
        }

        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Candidate Card */
        .candidate-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            cursor: pointer;
            border-top: 4px solid var(--accent);
        }

        .candidate-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .candidate-header {
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .candidate-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent);
        }

        .candidate-info {
            flex: 1;
        }

        .candidate-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .candidate-details {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .candidate-body {
            padding: 1.25rem;
        }

        .candidate-slogan {
            font-style: italic;
            color: var(--primary);
            margin-bottom: 0.75rem;
            text-align: center;
            font-weight: 500;
        }

        .candidate-program {
            color: var(--gray);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            overflow: hidden;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: normal;
        }

        .view-program-link {
            color: var(--primary);
            font-weight: 500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .view-program-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background-color: var(--secondary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            border-left: 4px solid var(--accent);
            max-width: 350px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background-color: #2e7d32;
        }

        .toast.error {
            background-color: #c62828;
        }

        .toast.warning {
            background-color: #ef6c00;
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--gray);
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main";
            }

            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 1000;
                width: 280px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                display: flex;
                transform: translateX(0);
            }

            .main-content {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .main-header {
                padding: 0 1rem;
            }

            .search-container {
                margin: 0 1rem;
                max-width: 300px;
            }

            .user-info {
                display: none;
            }

            .state-actions,
            .status-actions,
            .form-actions,
            .alert-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .candidates-grid {
                grid-template-columns: 1fr;
            }

            .candidature-header {
                padding: 1.5rem;
            }

            .candidature-title {
                font-size: 1.5rem;
            }

            .form-section {
                padding: 1.25rem;
            }
        }

        @media (max-width: 640px) {
            .main-content {
                padding: 1rem;
            }

            .section-title {
                font-size: 1.3rem;
            }

            .search-container {
                display: none;
            }

            .header-actions {
                margin-left: auto;
            }

            .state-message,
            .status-message {
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .candidate-header {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .candidate-image {
                width: 50px;
                height: 50px;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Mobile menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .mobile-menu-btn:hover {
            background-color: rgba(128, 0, 32, 0.05);
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: flex;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>

    <link rel="stylesheet" href="/assets/notifications.css">
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="main-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>

            <div class="header-actions">
                <div class="notifications-container">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>

                    <div class="notifications-panel" id="notificationsPanel">
                        <div class="notifications-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read" id="markAllReadBtn">
                                <i class="fas fa-check-double"></i> Tout marquer comme lu
                            </button>
                        </div>
                        <div class="notifications-body" id="notificationsList">
                            <!-- Les notifications seront insérées ici -->
                        </div>
                    </div>
                </div>

                <div class="user-menu">
                    <img src="https://tse1.explicit.bing.net/th/id/OIP.vTMq0lI0UHaCHxcvykT-EQHaHa?cb=12&w=1000&h=1000&rs=1&pid=ImgDetMain&o=7&rm=3"
                        alt="Photo de profil" class="user-avatar" id="userAvatar">
                    <div class="user-info">
                        <span class="user-name" id="userName">Étudiant</span>
                        <span class="user-role">Étudiant</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/assets/images/logo.png" alt="Logo UCAO"
                            style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <span>VOTE UCAO</span>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home nav-icon"></i>
                    <span class="nav-text">Accueil</span>
                </a>
                <a href="candidature.html" class="nav-item active">
                    <i class="fas fa-file-signature nav-icon"></i>
                    <span class="nav-text">Candidature</span>
                </a>
                <a href="elections.html" class="nav-item">
                    <i class="fas fa-vote-yea nav-icon"></i>
                    <span class="nav-text">Élections</span>
                </a>
                <a href="mes-candidatures.html" class="nav-item">
                    <i class="fas fa-list nav-icon"></i>
                    <span class="nav-text">Mes Candidatures</span>
                </a>
                <a href="vote.html" class="nav-item">
                    <i class="fas fa-check nav-icon"></i>
                    <span class="nav-text">Voter</span>
                </a>
                <a href="results.html" class="nav-item">
                    <i class="fas fa-chart-bar nav-icon"></i>
                    <span class="nav-text">Résultats</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <i class="fas fa-user nav-icon"></i>
                    <span class="nav-text">Profil</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="dashboard.html"><i class="fas fa-home"></i> Accueil</a>
                <i class="fas fa-chevron-right"></i>
                <span>Candidature</span>
            </div>

            <!-- Message d'état quand aucune élection n'est spécifiée -->
            <div class="state-message" id="noElectionMessage" style="display: none;">
                <div class="state-icon">
                    <i class="fas fa-hand-point-right"></i>
                </div>
                <h2 class="state-title">Aucune élection sélectionnée</h2>
                <p class="state-description">
                    Pour soumettre une candidature, vous devez d'abord sélectionner une élection.
                    Veuillez choisir une élection dans la liste disponible.
                </p>
                <div class="state-actions">
                    <a href="elections.html" class="btn btn-primary">
                        <i class="fas fa-list"></i>
                        Voir les élections
                    </a>
                    <a href="dashboard.html" class="btn btn-secondary">
                        <i class="fas fa-house"></i>
                        Retour à l'accueil
                    </a>
                </div>
            </div>

            <!-- Candidature Header -->
            <div class="candidature-header" id="candidatureHeader" style="display: none;">
                <h1 class="candidature-title" id="electionTitle">Déposer sa candidature</h1>
                <p class="candidature-subtitle" id="electionSubtitle">Remplissez le formulaire pour soumettre votre
                    candidature</p>
            </div>

            <!-- Indicateur de chargement -->
            <div class="loading-state" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <p>Chargement des informations de l'élection...</p>
            </div>

            <!-- Eligibility Alert -->
            <div class="eligibility-alert" id="eligibilityAlert" style="display: none;">
                <div class="alert-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Non éligible
                </div>
                <div class="alert-description" id="eligibilityMessage">
                    Vous n'êtes pas éligible pour cette élection.
                </div>
                <div class="alert-actions">
                    <a href="elections.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i>
                        Retour aux élections
                    </a>
                </div>
            </div>

            <!-- Candidature Form -->
            <div class="form-section" id="candidatureForm" style="display: none;">
                <h2 class="form-title"><i class="fas fa-pen-to-square"></i> Formulaire de candidature</h2>

                <form id="candidatureFormElement">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Élection</label>
                            <input type="text" class="form-input" id="electionName" readonly>
                        </div>

                        <div class="form-group" id="sloganGroup">
                            <label for="slogan" class="form-label required">Slogan de campagne</label>
                            <input type="text" id="slogan" class="form-input" placeholder="Votre slogan accrocheur"
                                maxlength="50">
                            <div class="form-help">Maximum 50 caractères <span id="sloganCounter"></span></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Photo de profil</label>
                            <div class="image-upload">
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-arrow-up"></i>
                                    </div>
                                    <div class="upload-text">Glissez-déposez votre photo ici ou cliquez pour
                                        sélectionner</div>
                                    <div class="upload-hint">Formats acceptés: JPG, PNG (max. 2MB)</div>
                                    <input type="file" id="photoUpload" accept="image/jpeg,image/png"
                                        style="display: none;">
                                </div>
                                <div class="upload-preview" id="uploadPreview">
                                    <img src="" alt="Aperçu" class="preview-image" id="previewImage">
                                    <div class="remove-image" id="removeImage">×</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group full-width" id="programGroup">
                            <label for="program" class="form-label required">Programme électoral</label>
                            <textarea id="program" class="form-textarea"
                                placeholder="Décrivez votre programme, vos propositions et vos engagements..."
                                minlength="100" maxlength="500" rows="6"></textarea>
                            <div class="form-help">Minimum 100 caractères, maximum 500 caractères <span
                                    id="programCounter"></span></div>
                        </div>

                        <div class="form-group full-width">
                            <label for="motivation" class="form-label required">Lettre de motivation</label>
                            <textarea id="motivation" class="form-textarea"
                                placeholder="Expliquez pourquoi vous êtes le meilleur candidat pour ce poste..."
                                required minlength="50" maxlength="300" rows="5"></textarea>
                            <div class="form-help">Minimum 50 caractères, maximum 300 caractères <span
                                    id="motivationCounter"></span></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">
                            <i class="fas fa-xmark"></i>
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                            Soumettre ma candidature
                        </button>
                    </div>
                </form>
            </div>

            <!-- Section Liste des Candidats -->
            <div class="form-section" id="candidatesSection" style="display: none;">
                <h2 class="form-title"><i class="fas fa-users"></i> Candidats à cette élection</h2>

                <div id="candidatesList">
                    <div class="loading" id="candidatesLoading">
                        <div class="spinner"></div>
                        <p>Chargement des candidats...</p>
                    </div>
                </div>

                <div class="empty-state" id="noCandidatesMessage">
                    <i class="fas fa-user-slash"></i>
                    <h3>Aucun candidat pour le moment</h3>
                    <p>Soyez le premier à postuler pour cette élection !</p>
                </div>
            </div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage" style="display: none;">
                <div class="status-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <h2 class="status-title">Candidature en attente de validation</h2>
                <p class="status-description">
                    Votre candidature a été soumise avec succès et est maintenant en attente de validation par
                    l'administration. Vous serez notifié par email une fois que votre candidature aura été examinée.
                </p>
                <div class="status-actions">
                    <a href="dashboard.html" class="btn btn-primary">
                        <i class="fas fa-house"></i>
                        Retour à l'accueil
                    </a>
                    <a href="mes-candidatures.html" class="btn btn-secondary">
                        <i class="fas fa-list"></i>
                        Voir mes candidatures
                    </a>
                    <a href="elections.html" class="btn btn-secondary">
                        <i class="fas fa-list"></i>
                        Voir les autres élections
                    </a>
                </div>
            </div>
        </main>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="toast" id="toast">
        <i class="fas fa-circle-check" id="toastIcon"></i>
        <span id="toastMessage"></span>
    </div>
    <script src="/assets/config.js"></script>
    <script src="/assets/js/auth-guard.js"></script>
    <script src="/assets/js/common.js"></script>
    <script src="/assets/js/notificationService.js"></script>
    <script src="/assets/initNotifications.js"></script>
    <script>
        // Variables globales pour cette page
        let currentElection = null;
        let uploadedImageUrl = null;
        let electionCandidates = [];
        let userProfile = null;

        const CandidateService = {
            async getCandidates(electionId) {
                try {
                    const response = await fetch(`${API_URL}/api/candidats/elections/${electionId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) throw new Error(`Erreur ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Erreur récupération candidats:', error);
                    return [];
                }
            },

            async isCandidate(electionId) {
                try {
                    const response = await fetch(`${API_URL}/api/candidats/is-candidate/${electionId}`, {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) return false;
                    const data = await response.json();
                    return data.isCandidate || false;
                } catch (error) {
                    console.error('Erreur vérification candidature:', error);
                    return false;
                }
            }
        };

        const ElectionService = {
            async getElectionDetails(id) {
                return await BaseService.apiCall(`/elections/${id}`);
            },

            getElectionStatus(election) {
                const now = new Date();
                const startCandidature = new Date(election.dateDebutCandidature);
                const endCandidature = new Date(election.dateFinCandidature);

                if (now < startCandidature) return 'upcoming';
                if (now > endCandidature) return 'ended';
                return 'active';
            },

            getDelegueTypeLabel(type) {
                const types = {
                    'titulaire': 'Titulaire',
                    'suppleant': 'Suppléant',
                    'delegue': 'Délégué',
                    'bde': 'Bureau des Étudiants'
                };
                return types[type] || type;
            },

            getElectionTypeLabel(type) {
                const types = {
                    'SALLE': 'Responsable de Salle',
                    'ECOLE': 'Délégué d\'École',
                    'UNIVERSITE': 'Délégué Universitaire'
                };
                return types[type] || type;
            }
        };

        // Composant CandidateCard
        const CandidateCard = {
            create(candidate, options = {}) {
                return `
                    <div class="candidate-card" data-candidate-id="${candidate.candidatId}">
                        <div class="candidate-header">
                            <img src="${candidate.photoUrl || 'https://via.placeholder.com/60'}" 
                                 alt="${candidate.candidatPrenom} ${candidate.candidatNom}" 
                                 class="candidate-image"
                                 onerror="this.src='https://via.placeholder.com/60'">
                            <div class="candidate-info">
                                <div class="candidate-name">${candidate.candidatPrenom} ${candidate.candidatNom}</div>
                                <div class="candidate-details">
                                    ${candidate.filiere_nom || 'Filière inconnue'} - 
                                    ${candidate.annee ? `Année ${candidate.annee}` : 'Année non précisée'}
                                </div>
                                <div class="candidate-school">${candidate.ecole_nom || 'École non spécifiée'}</div>
                            </div>
                        </div>
                        <div class="candidate-body">
                            <div class="candidate-slogan">"${candidate.slogan}"</div>
                            <div class="candidate-program">${candidate.programme ? candidate.programme : 'Aucun programme disponible'}</div>
                            ${options.showViewProfile ? `
                                <a class="view-program-link" data-candidate-id="${candidate.candidatId}">
                                    <i class="fas fa-eye"></i> Voir le profil complet
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        };

        // Fonctions spécifiques à candidature
        async function loadUserProfile() {
            try {
                const response = await UserService.getProfile();
                userProfile = response.data || response;

                console.log('Profil utilisateur chargé:', userProfile);

                // Vérifier que nom et prenom sont présents
                if (!userProfile.nom || !userProfile.prenom) {
                    console.warn('Nom ou prénom manquant dans le profil utilisateur');
                    Common.showToast('Votre profil est incomplet. Veuillez le compléter avant de candidater.', 'warning');
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                Common.showToast('Erreur lors du chargement du profil', 'error');
            }
        }

        function hideAllSections() {
            document.getElementById('noElectionMessage').style.display = 'none';
            document.getElementById('candidatureHeader').style.display = 'none';
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('eligibilityAlert').style.display = 'none';
            document.getElementById('candidatureForm').style.display = 'none';
            document.getElementById('candidatesSection').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
        }

        function showNoElectionMessage() {
            hideAllSections();
            document.getElementById('noElectionMessage').style.display = 'block';
        }

        async function loadElectionDetails(electionId) {
            Common.showLoading();
            document.getElementById('loadingState').style.display = 'flex';

            try {
                const response = await ElectionService.getElectionDetails(electionId);

                if (response && response.data) {
                    currentElection = response.data;
                } else if (response && response.success && response.data) {
                    currentElection = response.data;
                } else if (response && response.id) {
                    currentElection = response;
                } else {
                    throw new Error('Structure de réponse invalide');
                }

                if (!currentElection) {
                    throw new Error('Élection non trouvée');
                }

                updateElectionDetails(currentElection);
                await checkEligibility(currentElection);
                await loadElectionCandidates(currentElection.id);

            } catch (error) {
                console.error('Erreur chargement détails élection:', error);
                Common.showToast('Impossible de charger les détails de l\'élection', 'error');
                showNoElectionMessage();
            } finally {
                Common.hideLoading();
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function updateElectionDetails(election) {
            document.getElementById('electionTitle').textContent = `Candidature: ${election.titre}`;
            document.getElementById('electionSubtitle').textContent = `Poste de ${ElectionService.getDelegueTypeLabel(election.delegueType)} - ${ElectionService.getElectionTypeLabel(election.type)}`;
            document.getElementById('electionName').value = election.titre;
            document.getElementById('candidatureHeader').style.display = 'block';

            // Adapter le formulaire selon la PHASE
            adaptFormForPhase(election.niveau);
        }

        // Fonction pour adapter le formulaire selon la phase de l'élection
        function adaptFormForPhase(niveau) {
            const sloganGroup = document.getElementById('sloganGroup');
            const programGroup = document.getElementById('programGroup');
            const sloganInput = document.getElementById('slogan');
            const programInput = document.getElementById('program');

            if (niveau === 'PHASE1') {
                // PHASE1 : Responsables de salle
                // Masquer slogan et programme
                if (sloganGroup) sloganGroup.style.display = 'none';
                if (programGroup) programGroup.style.display = 'none';

                // Retirer l'attribut required
                if (sloganInput) sloganInput.removeAttribute('required');
                if (programInput) programInput.removeAttribute('required');

                // Le slogan sera généré automatiquement dans handleFormSubmit()
            } else {
                // PHASE2 & PHASE3 : Délégués École/Université
                // Afficher slogan et programme
                if (sloganGroup) sloganGroup.style.display = 'block';
                if (programGroup) programGroup.style.display = 'block';

                // Ajouter l'attribut required
                if (sloganInput) sloganInput.setAttribute('required', 'required');
                if (programInput) programInput.setAttribute('required', 'required');
            }
        }

        // Fonction pour générer un slogan automatique pour PHASE1
        function generateSloganPhase1() {
            const slogans = [
                "Ensemble pour une salle organisée !",
                "Votre voix, notre priorité !",
                "Un délégué à votre écoute !",
                "Pour une meilleure communication !",
                "Responsable et engagé pour vous !",
                "Votre salle, notre engagement !",
                "Au service de la classe !",
                "Ensemble, réussissons !",
                "Votre représentant dévoué !",
                "Pour une salle solidaire !"
            ];

            // Choisir aléatoirement un slogan
            return slogans[Math.floor(Math.random() * slogans.length)];
        }

        async function checkEligibility(election) {
            try {
                // Vérifier d'abord si déjà candidat
                const isAlreadyCandidate = await CandidateService.isCandidate(election.id);
                if (isAlreadyCandidate) {
                    showEligibilityError('Vous êtes déjà candidat à cette élection.');
                    return;
                }

                // Vérifier la période de candidature
                const status = ElectionService.getElectionStatus(election);
                if (status !== 'active') {
                    const message = status === 'upcoming'
                        ? 'La période de candidature pour cette élection n\'a pas encore commencé.'
                        : 'La période de candidature pour cette élection est terminée.';
                    showEligibilityError(message);
                    return;
                }

                // Vérification d'éligibilité basique (sans API)
                const isEligible = await checkBasicEligibility(election);
                if (!isEligible) {
                    showEligibilityError('Vous ne remplissez pas les critères d\'éligibilité pour cette élection.');
                    return;
                }

                // Si toutes les vérifications passent, afficher le formulaire
                showCandidatureForm();

            } catch (error) {
                console.error('Erreur vérification éligibilité:', error);
                // En cas d'erreur, on laisse quand même l'utilisateur tenter de soumettre
                // car certaines vérifications peuvent échuer à cause de problèmes techniques
                showCandidatureForm();
                Common.showToast('Note: Certaines vérifications techniques ont échoué. Vous pouvez quand même soumettre votre candidature.', 'warning');
            }
        }

        // Vérification d'éligibilité basique sans appel API
        async function checkBasicEligibility(election) {
            if (!userProfile) {
                console.error('Profil utilisateur non chargé');
                return false;
            }

            // Vérifications basiques sans appel API
            if (!userProfile.ecoleId || !userProfile.filiereId || !userProfile.annee) {
                console.warn('Profil utilisateur incomplet');
                return false;
            }

            // Vérifier l'école si spécifiée dans l'élection
            if (election.ecoleId && userProfile.ecoleId !== election.ecoleId) {
                console.log('École non éligible');
                return false;
            }

            // Vérifier la filière si spécifiée
            if (election.filiereId && userProfile.filiereId !== election.filiereId) {
                console.log('Filière non éligible');
                return false;
            }

            // Vérifier l'année si requise
            if (election.anneeRequise && userProfile.annee < election.anneeRequise) {
                console.log('Année non éligible');
                return false;
            }

            return true;
        }

        async function checkUserEligibility(election) {
            if (!userProfile) {
                console.error('Profil utilisateur non chargé');
                return false;
            }

            try {
                if (!userProfile.ecoleId || !userProfile.filiereId || !userProfile.annee) {
                    console.warn('Profil utilisateur incomplet');
                    return false;
                }

                if (election.ecoleId && userProfile.ecoleId !== election.ecoleId) {
                    console.log('École non éligible');
                    return false;
                }

                if (election.filiereId && userProfile.filiereId !== election.filiereId) {
                    console.log('Filière non éligible');
                    return false;
                }

                if (election.anneeRequise && userProfile.annee < election.anneeRequise) {
                    console.log('Année non éligible');
                    return false;
                }

                const eligibilityResponse = await BaseService.apiCall(`/elections/${election.id}/check-eligibility`);
                return eligibilityResponse.eligible !== false;

            } catch (error) {
                console.error('Erreur vérification éligibilité détaillée:', error);
                return true;
            }
        }

        function showEligibilityError(message) {
            hideAllSections();
            document.getElementById('candidatureHeader').style.display = 'block';
            document.getElementById('eligibilityAlert').style.display = 'block';
            document.getElementById('eligibilityMessage').textContent = message;
        }

        function showCandidatureForm() {
            hideAllSections();
            document.getElementById('candidatureHeader').style.display = 'block';
            document.getElementById('candidatureForm').style.display = 'block';
            document.getElementById('candidatesSection').style.display = 'block';
        }

        async function loadElectionCandidates(electionId) {
            const container = document.getElementById('candidatesList');
            const loadingElement = document.getElementById('candidatesLoading');
            const emptyElement = document.getElementById('noCandidatesMessage');

            if (!container) return;

            loadingElement.style.display = 'flex';
            emptyElement.style.display = 'none';
            container.innerHTML = '';

            try {
                const response = await CandidateService.getCandidates(electionId);

                let candidates = [];
                if (response && response.candidates) {
                    candidates = response.candidates;
                } else if (response && Array.isArray(response)) {
                    candidates = response;
                }

                if (candidates && candidates.length > 0) {
                    electionCandidates = candidates;
                    renderCandidatesList(electionCandidates);
                } else {
                    showNoCandidates();
                }
            } catch (error) {
                console.error('Erreur chargement candidats:', error);
                showNoCandidates();
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        function renderCandidatesList(candidates) {
            const container = document.getElementById('candidatesList');
            const emptyElement = document.getElementById('noCandidatesMessage');

            if (!container) return;

            if (!candidates || candidates.length === 0) {
                showNoCandidates();
                return;
            }

            emptyElement.style.display = 'none';

            container.innerHTML = `
                <div class="candidates-grid">
                    ${candidates.map(candidate =>
                CandidateCard.create(candidate, {
                    showProgram: true,
                    showViewProfile: true
                })
            ).join('')}
                </div>
            `;

            attachCandidateCardEvents();
        }

        function showNoCandidates() {
            const container = document.getElementById('candidatesList');
            const emptyElement = document.getElementById('noCandidatesMessage');

            if (container && emptyElement) {
                container.innerHTML = '';
                emptyElement.style.display = 'block';
            }
        }

        function initializeNotifications() {
            const notificationService = new NotificationService();
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationsPanel = document.getElementById('notificationsPanel');
            const markAllReadBtn = document.getElementById('markAllReadBtn');

            notificationBtn.addEventListener('click', () => {
                notificationsPanel.classList.toggle('show');
                notificationService.markAllAsRead();
                updateNotificationBadge();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.notifications-container')) {
                    notificationsPanel.classList.remove('show');
                }
            });

            markAllReadBtn.addEventListener('click', () => {
                notificationService.markAllAsRead();
                updateNotificationBadge();
                renderNotifications();
            });

            function updateNotificationBadge() {
                const unreadCount = notificationService.getUnreadCount();
                const badge = document.getElementById('notificationBadge');
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }

            function renderNotifications() {
                const notifications = notificationService.getNotifications();
                const container = document.getElementById('notificationsList');

                if (notifications.length === 0) {
                    container.innerHTML = '<div class="no-notifications">Aucune notification</div>';
                    return;
                }

                container.innerHTML = notifications
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(notif => `
                        <div class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}">
                            <div class="notification-icon">
                                <i class="fas ${getNotificationIcon(notif.type)}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-text">${notif.message}</div>
                                <div class="notification-time">${formatNotificationDate(notif.date)}</div>
                            </div>
                        </div>
                    `).join('');

                container.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const notifId = item.dataset.id;
                        notificationService.markAsRead(notifId);
                        item.classList.remove('unread');
                        updateNotificationBadge();
                    });
                });
            }

            function getNotificationIcon(type) {
                const icons = {
                    'success': 'fa-check-circle',
                    'warning': 'fa-exclamation-triangle',
                    'error': 'fa-times-circle',
                    'info': 'fa-info-circle',
                    'election': 'fa-vote-yea',
                    'candidature': 'fa-file-signature',
                    'profile': 'fa-user',
                    'system': 'fa-cog'
                };
                return icons[type] || 'fa-bell';
            }

            function formatNotificationDate(date) {
                const now = new Date();
                const notifDate = new Date(date);
                const diff = now - notifDate;
                const diffMinutes = Math.floor(diff / 60000);
                const diffHours = Math.floor(diff / 3600000);
                const diffDays = Math.floor(diff / 86400000);

                if (diffMinutes < 60) {
                    return `Il y a ${diffMinutes} minute${diffMinutes > 1 ? 's' : ''}`;
                } else if (diffHours < 24) {
                    return `Il y a ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
                } else if (diffDays < 7) {
                    return `Il y a ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
                } else {
                    return notifDate.toLocaleDateString();
                }
            }

            renderNotifications();
            updateNotificationBadge();
            setInterval(() => {
                notificationService.fetchNewNotifications().then(() => {
                    renderNotifications();
                    updateNotificationBadge();
                });
            }, 30000);
        }

        function initEventHandlers() {
            try {
                const form = document.getElementById('candidatureFormElement');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }

                const cancelBtn = document.getElementById('cancelBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', handleCancel);
                }

                initImageUploadHandlers();
                initCharacterCounters();

            } catch (error) {
                console.error('Erreur initialisation handlers:', error);
                Common.showToast('Une erreur est survenue lors de l\'initialisation', 'error');
            }
        }

        // Fonction pour initialiser les compteurs de caractères
        function initCharacterCounters() {
            const slogan = document.getElementById('slogan');
            const program = document.getElementById('program');
            const motivation = document.getElementById('motivation');

            if (slogan) {
                slogan.addEventListener('input', function () {
                    updateCounter('sloganCounter', this.value.length, this.maxLength);
                });
            }

            if (program) {
                program.addEventListener('input', function () {
                    updateCounter('programCounter', this.value.length, this.maxLength);
                });
            }

            if (motivation) {
                motivation.addEventListener('input', function () {
                    updateCounter('motivationCounter', this.value.length, this.maxLength);
                });
            }
        }

        // Fonction pour mettre à jour un compteur
        function updateCounter(counterId, currentLength, maxLength) {
            const counter = document.getElementById(counterId);
            if (counter) {
                const remaining = maxLength - currentLength;
                counter.textContent = `(${currentLength}/${maxLength})`;

                // Changer la couleur si proche de la limite
                if (remaining < 20) {
                    counter.style.color = 'var(--warning)';
                } else if (remaining === 0) {
                    counter.style.color = 'var(--danger)';
                } else {
                    counter.style.color = 'var(--gray)';
                }
            }
        }

        function initImageUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const photoUpload = document.getElementById('photoUpload');
            const uploadPreview = document.getElementById('uploadPreview');
            const previewImage = document.getElementById('previewImage');
            const removeImage = document.getElementById('removeImage');

            if (!uploadArea || !photoUpload) return;

            uploadArea.addEventListener('click', () => {
                photoUpload.click();
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });

            photoUpload.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            });

            if (removeImage) {
                removeImage.addEventListener('click', () => {
                    uploadPreview.style.display = 'none';
                    uploadArea.style.display = 'block';
                    uploadedImageUrl = null;
                    photoUpload.value = '';
                });
            }
        }

        async function handleImageUpload(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            if (!allowedTypes.includes(file.type)) {
                Common.showToast('Format de fichier non supporté. Utilisez JPG ou PNG.', 'error');
                return false;
            }

            if (file.size > 2 * 1024 * 1024) {
                Common.showToast('L\'image ne doit pas dépasser 2MB.', 'error');
                return false;
            }

            showImageUploadLoading();

            try {
                const formData = new FormData();
                formData.append('image', file);

                const token = localStorage.getItem('token');
                const API_URL = CONFIG.BASE_URL;

                console.log('Tentative d\'upload vers:', `${API_URL}/api/upload/image`);

                const response = await fetch(`${API_URL}/api/upload/candidats/image`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                console.log('Statut de la réponse:', response.status);

                if (!response.ok) {
                    let errorMessage = `Erreur ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // Si la réponse n'est pas du JSON
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Réponse complète:', result);

                // ADAPTATION: Vérifier la structure de réponse de votre backend
                if (result.success) {
                    // Votre backend retourne probablement {success: true, data: {photoUrl: ...}}
                    uploadedImageUrl = result.data?.photoUrl || result.photoUrl || result.url;

                    if (!uploadedImageUrl) {
                        throw new Error('URL de l\'image non reçue du serveur');
                    }

                    // Afficher l'aperçu
                    document.getElementById('previewImage').src = uploadedImageUrl;
                    document.getElementById('uploadPreview').style.display = 'block';
                    document.getElementById('uploadArea').style.display = 'none';

                    Common.showToast('Image téléchargée avec succès', 'success');
                    return true;
                } else {
                    throw new Error(result.message || 'Erreur lors de l\'upload');
                }

            } catch (error) {
                console.error('Erreur détaillée upload:', error);
                resetImageUpload();

                // Messages d'erreur plus spécifiques
                let userMessage = error.message || 'Erreur lors du téléchargement de l\'image';
                if (error.message.includes('401') || error.message.includes('token')) {
                    userMessage = 'Session expirée. Veuillez vous reconnecter.';
                } else if (error.message.includes('413') || error.message.includes('taille')) {
                    userMessage = 'Fichier trop volumineux (max 2MB)';
                } else if (error.message.includes('400') || error.message.includes('format')) {
                    userMessage = 'Format de fichier non supporté';
                } else if (error.message.includes('500')) {
                    userMessage = 'Erreur serveur. Veuillez réessayer.';
                }

                Common.showToast(userMessage, 'error');
                return false;
            }
        }

        function showImageUploadLoading() {
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div class="loading-spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                        <div>Téléchargement en cours...</div>
                    </div>
                `;
            }
        }

        function resetImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const uploadPreview = document.getElementById('uploadPreview');

            if (uploadArea) {
                uploadArea.innerHTML = `
            <div class="upload-icon">
                <i class="fas fa-cloud-arrow-up"></i>
            </div>
            <div class="upload-text">Glissez-déposez votre photo ici ou cliquez pour sélectionner</div>
            <div class="upload-hint">Formats acceptés: JPG, PNG (max. 2MB)</div>
        `;
                uploadArea.style.display = 'block';

                // Réinitialiser l'input file
                const photoUpload = document.getElementById('photoUpload');
                if (photoUpload) {
                    photoUpload.value = '';
                }
            }

            if (uploadPreview) {
                uploadPreview.style.display = 'none';
            }

            uploadedImageUrl = null;

            // Réattacher les événements
            setTimeout(() => {
                initImageUploadHandlers();
            }, 100);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Soumission en cours...';
            submitBtn.disabled = true;

            Common.showLoading();

            try {
                // Gérer le slogan selon la PHASE
                let sloganValue, programmeValue;

                if (currentElection.niveau === 'PHASE1') {
                    // PHASE1 : Générer slogan automatique, programme vide
                    sloganValue = generateSloganPhase1();
                    programmeValue = 'Programme standard de responsable de salle'; // Valeur par défaut
                } else {
                    // PHASE2 & PHASE3 : Utiliser les valeurs du formulaire
                    sloganValue = document.getElementById('slogan').value.trim();
                    programmeValue = document.getElementById('program').value.trim();
                }

                // STRUCTURE CORRECTE selon votre backend
                const candidatureData = {
                    electionId: currentElection.id,
                    slogan: sloganValue,
                    programme: programmeValue,
                    motivation: document.getElementById('motivation').value.trim(),
                    photoUrl: uploadedImageUrl,
                    // AJOUT DES CHAMPS OBLIGATOIRES manquants
                    nom: userProfile.nom,
                    prenom: userProfile.prenom
                };

                console.log('Données complètes envoyées:', candidatureData);

                // Vérifier que tous les champs obligatoires sont présents
                const requiredFields = ['nom', 'prenom', 'slogan', 'programme', 'motivation', 'photoUrl', 'electionId'];
                const missingFields = requiredFields.filter(field => !candidatureData[field]);

                if (missingFields.length > 0) {
                    throw new Error(`Champs manquants: ${missingFields.join(', ')}`);
                }

                const token = getToken();
                const response = await fetch(`${API_URL}/api/candidats`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(candidatureData)
                });

                console.log('Statut de la réponse:', response.status);

                if (!response.ok) {
                    let errorMessage = `Erreur ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                        console.error('Détails erreur:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Réponse succès:', result);

                Common.showToast('Candidature soumise avec succès !', 'success');
                showSuccessMessage();

                // Recharger la liste des candidats
                setTimeout(() => {
                    loadElectionCandidates(currentElection.id);
                }, 2000);

            } catch (error) {
                console.error('Erreur détaillée soumission:', error);

                // Messages d'erreur spécifiques
                let userMessage = error.message;

                if (error.message.includes('400')) {
                    userMessage = 'Données incomplètes. Vérifiez que tous les champs sont remplis.';
                } else if (error.message.includes('déjà candidat') || error.message.includes('already')) {
                    userMessage = 'Vous êtes déjà candidat à cette élection';
                } else if (error.message.includes('Champs manquants')) {
                    userMessage = 'Informations manquantes. Veuillez compléter votre profil.';
                } else if (error.message.includes('401')) {
                    userMessage = 'Session expirée. Veuillez vous reconnecter.';
                    setTimeout(() => window.location.href = '/login', 2000);
                } else if (error.message.includes('500')) {
                    userMessage = 'Erreur serveur. Veuillez réessayer.';
                }

                Common.showToast(userMessage, 'error');
            } finally {
                Common.hideLoading();
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function validateForm() {
            const motivation = document.getElementById('motivation').value.trim();

            // Vérification de l'image
            if (!uploadedImageUrl) {
                Common.showToast('Veuillez uploader une photo de profil', 'error');
                return false;
            }

            // Vérification de la lettre de motivation (obligatoire pour toutes les phases)
            if (!motivation) {
                Common.showToast('Veuillez saisir votre lettre de motivation', 'error');
                document.getElementById('motivation').focus();
                return false;
            }

            if (motivation.length < 100) {
                Common.showToast('La lettre de motivation doit contenir au moins 100 caractères', 'error');
                document.getElementById('motivation').focus();
                return false;
            }

            if (motivation.length > 1000) {
                Common.showToast('La lettre de motivation ne doit pas dépasser 1000 caractères', 'error');
                document.getElementById('motivation').focus();
                return false;
            }

            // Pour PHASE2 et PHASE3, vérifier slogan et programme
            if (currentElection && currentElection.niveau !== 'PHASE1') {
                const slogan = document.getElementById('slogan').value.trim();
                const program = document.getElementById('program').value.trim();

                if (!slogan) {
                    Common.showToast('Veuillez saisir un slogan', 'error');
                    document.getElementById('slogan').focus();
                    return false;
                }

                if (!program) {
                    Common.showToast('Veuillez saisir votre programme électoral', 'error');
                    document.getElementById('program').focus();
                    return false;
                }

                // Validation des longueurs
                if (slogan.length > 100) {
                    Common.showToast('Le slogan ne doit pas dépasser 100 caractères', 'error');
                    document.getElementById('slogan').focus();
                    return false;
                }

                if (program.length < 50) {
                    Common.showToast('Le programme doit contenir au moins 50 caractères', 'error');
                    document.getElementById('program').focus();
                    return false;
                }

                if (program.length > 2000) {
                    Common.showToast('Le programme ne doit pas dépasser 2000 caractères', 'error');
                    document.getElementById('program').focus();
                    return false;
                }
            }

            return true;
        }

        function showSuccessMessage() {
            hideAllSections();
            document.getElementById('statusMessage').style.display = 'block';
        }

        function handleCancel() {
            if (confirm('Êtes-vous sûr de vouloir annuler ? Toutes les modifications seront perdues.')) {
                window.location.href = `elections.html`;
            }
        }

        function attachCandidateCardEvents() {
            document.addEventListener('click', function (e) {
                if (e.target.closest('.view-program-link')) {
                    const link = e.target.closest('.view-program-link');
                    const candidateId = link.getAttribute('data-candidate-id');
                    viewCandidateProfile(candidateId);
                }

                if (e.target.closest('.candidate-card')) {
                    const card = e.target.closest('.candidate-card');
                    const candidateId = card.getAttribute('data-candidate-id');
                    viewCandidateProfile(candidateId);
                }
            });
        }

        function viewCandidateProfile(candidateId) {
            const candidate = electionCandidates.find(c => c.candidatId == candidateId || c.id == candidateId);
            if (candidate) {
                const message = `
                    ${candidate.candidatPrenom} ${candidate.candidatNom}
                    ${candidate.filiere_nom ? `\nFilière: ${candidate.filiere_nom}` : ''}
                    ${candidate.annee ? `\nAnnée: ${candidate.annee}` : ''}
                    ${candidate.slogan ? `\nSlogan: "${candidate.slogan}"` : ''}
                `;
                alert(message);
            }
        }

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', async function () {
            if (!Common.checkAuth()) return;

            // Initialiser les éléments communs
            Common.initCommonElements();
            await Common.loadUserProfileInHeader();
            initializeNotifications();

            // Initialiser le menu burger mobile
            const burger = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            if (burger && sidebar && overlay) {
                burger.addEventListener('click', function (e) {
                    e.stopPropagation();
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });

                overlay.addEventListener('click', function () {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });

                // Fermer le menu en cliquant en dehors (mobile)
                document.addEventListener('click', function (e) {
                    const isMenuOpen = sidebar.classList.contains('active');
                    if (isMenuOpen && !sidebar.contains(e.target) && !burger.contains(e.target)) {
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                    }
                });
            }

            // Charger le profil utilisateur pour le formulaire
            await loadUserProfile();

            // Masquer tous les états initialement
            hideAllSections();

            // Vérifier si une élection est spécifiée dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const electionId = urlParams.get('electionId') || urlParams.get('election');

            if (!electionId) {
                showNoElectionMessage();
                return;
            }

            // Charger les détails de l'élection
            await loadElectionDetails(electionId);

            // Initialiser les gestionnaires d'événements
            initEventHandlers();
        });
    </script>
</body>

</html>