<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voter - UCAO-UUC</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles CSS -->
    <link rel="stylesheet" href="/assets/css/components/election-card.css">
    <link rel="stylesheet" href="/assets/css/components/candidate-card.css">
    <link rel="stylesheet" href="/assets/css/pages/vote.css">
</head>

<body>
    <header>
        <div class="logo"><i class="fa-solid fa-graduation-cap"></i> UCAO-UUC</div>
        <div class="user-nav">
            <span><i class="fa-solid fa-user"></i> <span id="userName">Étudiant</span></span>
            <a href="/user/profile"><i class="fa-solid fa-user"></i> Profil</a>
            <a href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
        </div>
        <div class="burger" id="burger">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </header>

    <div class="overlay" id="overlay"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li><a href="/user/dashboard.html"><i class="fa-solid fa-house"></i> Accueil</a></li>
                <li><a href="/user/candidature"><i class="fa-solid fa-file-signature"></i> Candidature</a></li>
                <li><a href="/user/elections"><i class="fa-solid fa-list"></i> Élections</a></li>
                <li><a href="/user/mes-candidatures"><i class="fa-solid fa-list"></i> Mes Candidatures</a></li>
                <li><a href="/user/vote" class="active"><i class="fa-solid fa-check"></i> Voter</a></li>
                <li><a href="/user/resultats"><i class="fa-solid fa-chart-bar"></i> Résultats</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="dashboard.html"><i class="fa-solid fa-house"></i> Accueil</a>
                <i class="fa-solid fa-chevron-right"></i>
                <span>Voter</span>
            </div>

            <!-- Vote Container -->
            <div class="vote-container">
                <!-- Left Column: Elections and Candidates -->
                <div class="vote-main-content">
                    <!-- Elections List -->
                    <div class="elections-section">
                        <h2 class="section-title">
                            <i class="fa-solid fa-vote-yea"></i>
                            Élections en cours
                        </h2>
                        <div class="elections-list" id="electionsList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Chargement des élections...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Candidates Section -->
                    <div class="candidates-section" id="candidatesSection">
                        <div class="no-election-selected">
                            <i class="fa-solid fa-hand-pointer"></i>
                            <p>Sélectionnez une élection pour voir les candidats</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Vote Summary -->
                <div class="vote-summary">
                    <h2 class="summary-title">Récapitulatif de vote</h2>
                    <div class="summary-items" id="summaryItems">
                        <div class="empty-summary">
                            <i class="fa-solid fa-inbox"></i>
                            <p>Aucun vote sélectionné pour le moment</p>
                        </div>
                    </div>
                    <div class="vote-actions">
                        <button class="btn btn-primary" id="submitVoteBtn" disabled>
                            <i class="fa-solid fa-paper-plane"></i>
                            Soumettre mon vote
                        </button>
                        <button class="btn btn-secondary" id="resetVoteBtn">
                            <i class="fa-solid fa-rotate-left"></i>
                            Réinitialiser
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Confirmer votre vote</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-icon">
                    <i class="fa-solid fa-circle-question"></i>
                </div>
                <p class="modal-text" id="confirmationText">
                    Êtes-vous sûr de vouloir soumettre votre vote? Cette action est irréversible.
                </p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelVoteBtn">
                        <i class="fa-solid fa-xmark"></i>
                        Annuler
                    </button>
                    <button class="btn btn-primary" id="confirmVoteBtn">
                        <i class="fa-solid fa-check"></i>
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Vote enregistré</h2>
                <button class="modal-close" id="closeSuccessModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-icon">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
                <p class="modal-text">
                    Votre vote a été enregistré avec succès. Merci pour votre participation!
                </p>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="backToElectionsBtn">
                        <i class="fa-solid fa-list"></i>
                        Retour aux élections
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <i class="fa-solid fa-circle-check" id="toastIcon"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Chargement des scripts -->
    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/utils/api.js"></script>
    <script src="/assets/js/services/eligibilityService.js"></script>
    <script src="/assets/js/services/electionService.js"></script>
    <script src="/assets/js/services/candidateService.js"></script>
    <script src="/assets/js/services/voteService.js"></script>
    <script src="/assets/js/components/ElectionCard.js"></script>
    <script src="/assets/js/components/CandidateCard.js"></script>
    <script src="/assets/js/main.js"></script>

    <script>
        // Variables globales pour cette page
        let allElections = [];
        let allCandidates = [];
        let selectedElection = null;
        let selectedCandidates = {};
        let voteTokens = {};

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', async function () {
            // Vérifier que l'utilisateur est connecté
            if (!localStorage.getItem('token')) {
                window.location.href = '/user/login';
                return;
            }

            // Initialiser les gestionnaires d'événements
            initEventHandlers();

            // Charger les données
            await loadPageData();
        });

        // Chargement des données de la page
        async function loadPageData() {
            showLoading();

            try {
                // Charger les élections où l'utilisateur peut voter
                await loadElections();

                // Charger tous les candidats
                await loadCandidates();

            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                showToast('Erreur de chargement des données', 'error');
            } finally {
                hideLoading();
            }
        }

        // Charger les élections accessibles
        async function loadElections() {
            try {
                // Utiliser la route correcte pour les élections de l'utilisateur
                const data = await ElectionService.getElectionsForVoting();

                if (data && data.length > 0) {
                    allElections = data;
                    displayElections(data);
                } else {
                    showElectionsError('Aucune élection disponible pour le moment');
                }
            } catch (error) {
                console.error('Erreur chargement élections:', error);
                showElectionsError('Erreur de chargement des élections');
            }
        }

        // Afficher les élections
        function displayElections(elections) {
            const container = document.getElementById('electionsList');
            if (!container) return;

            if (elections.length === 0) {
                container.innerHTML = `
                    <div class="no-data-message">
                        <i class="fa-solid fa-calendar-check"></i>
                        <h3>Aucune élection en cours</h3>
                        <p>Vous n'avez aucune élection en cours où vous pouvez voter.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = elections.map(election =>
                ElectionCard.create(election, {
                    showActions: false,
                    showDetails: true,
                    clickable: true
                })
            ).join('');

            // Ajouter les événements de clic sur les cartes d'élection
            attachElectionCardEvents();
        }

        // Attacher les événements aux cartes d'élection
        function attachElectionCardEvents() {
            document.querySelectorAll('.election-card').forEach(card => {
                card.addEventListener('click', function () {
                    const electionId = this.dataset.electionId;
                    const election = allElections.find(e => e.id == electionId);

                    if (election) {
                        selectElection(election);
                    }
                });
            });
        }

        // Charger tous les candidats
        async function loadCandidates() {
            try {
                const data = await CandidateService.getCandidates();

                if (data && Array.isArray(data)) {
                    allCandidates = data;
                } else if (data && data.candidates && Array.isArray(data.candidates)) {
                    allCandidates = data.candidates;
                }
            } catch (error) {
                console.error('Erreur chargement candidats:', error);
            }
        }

        // Sélectionner une élection
        async function selectElection(election) {
            // Vérifier si l'utilisateur a déjà voté pour cette élection
            const hasVoted = await VoteService.hasVoted(election.id);

            if (hasVoted) {
                showToast('Vous avez déjà voté pour cette élection', 'warning');
                return;
            }

            selectedElection = election;

            // Mettre à jour la sélection visuelle
            document.querySelectorAll('.election-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.electionId == election.id) {
                    card.classList.add('selected');
                }
            });

            // Afficher les candidats de cette élection
            await displayElectionCandidates(election);
        }

        // Afficher les candidats d'une élection
        async function displayElectionCandidates(election) {
            const section = document.getElementById('candidatesSection');
            if (!section) return;

            // Afficher la section des candidats
            section.innerHTML = `
                <h2 class="section-title">
                    <i class="fa-solid fa-users"></i>
                    Candidats - ${election.titre}
                </h2>
                <div class="election-info">
                    <div class="election-info-title">Informations sur l'élection</div>
                    <div class="election-info-details">
                        <div class="election-info-item">
                            <i class="fa-solid fa-graduation-cap"></i>
                            <span>${election.ecole || 'Non spécifié'}</span>
                        </div>
                        ${election.filiere ? `
                        <div class="election-info-item">
                            <i class="fa-solid fa-layer-group"></i>
                            <span>${election.filiere}</span>
                        </div>
                        ` : ''}
                        ${election.annee ? `
                        <div class="election-info-item">
                            <i class="fa-solid fa-calendar"></i>
                            <span>Année ${election.annee}</span>
                        </div>
                        ` : ''}
                        <div class="election-info-item">
                            <i class="fa-solid fa-user-tie"></i>
                            <span>${ElectionService.getDelegueTypeLabel(election.delegueType)}</span>
                        </div>
                    </div>
                </div>
                <div class="candidates-list" id="candidatesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des candidats...</p>
                    </div>
                </div>
            `;

            const candidatesList = document.getElementById('candidatesList');

            try {
                // Récupérer les candidats pour cette élection
                const electionCandidates = allCandidates.filter(c => c.electionId == election.id);

                if (electionCandidates.length === 0) {
                    candidatesList.innerHTML = `
                        <div class="no-data-message">
                            <i class="fa-solid fa-user-slash"></i>
                            <h3>Aucun candidat pour cette élection</h3>
                            <p>Aucun candidat ne s'est présenté pour cette élection.</p>
                        </div>
                    `;
                    return;
                }

                // Afficher les candidats
                candidatesList.innerHTML = electionCandidates.map(candidate =>
                    CandidateCard.create(candidate, {
                        showProgram: true,
                        showViewProfile: false,
                        showVote: true,
                        electionId: election.id
                    })
                ).join('');

                // Ajouter les événements de sélection des candidats
                attachCandidateSelectionEvents();

            } catch (error) {
                console.error('Erreur affichage candidats:', error);
                candidatesList.innerHTML = `
                    <div class="no-data-message">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        <h3>Erreur de chargement</h3>
                        <p>Impossible de charger les candidats.</p>
                    </div>
                `;
            }
        }

        // Attacher les événements de sélection des candidats
        function attachCandidateSelectionEvents() {
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.addEventListener('click', function () {
                    const candidateId = this.dataset.candidateId;
                    const candidate = allCandidates.find(c => c.id == candidateId);

                    if (candidate && selectedElection) {
                        selectCandidate(selectedElection, candidate);
                    }
                });
            });
        }

        // Sélectionner un candidat
        function selectCandidate(election, candidate) {
            // Désélectionner tous les candidats pour cette élection
            document.querySelectorAll(`.candidate-card[data-election-id="${election.id}"]`).forEach(card => {
                card.classList.remove('selected');
            });

            // Sélectionner le candidat choisi
            const selectedCard = document.querySelector(`.candidate-card[data-candidate-id="${candidate.id}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Stocker la sélection
            selectedCandidates[election.id] = candidate;

            // Mettre à jour le récapitulatif
            updateVoteSummary();
        }

        // Mettre à jour le récapitulatif de vote
        function updateVoteSummary() {
            const container = document.getElementById('summaryItems');
            const submitBtn = document.getElementById('submitVoteBtn');

            if (!container) return;

            if (Object.keys(selectedCandidates).length === 0) {
                container.innerHTML = `
                    <div class="empty-summary">
                        <i class="fa-solid fa-inbox"></i>
                        <p>Aucun vote sélectionné pour le moment</p>
                    </div>
                `;
                submitBtn.disabled = true;
                return;
            }

            container.innerHTML = '';

            for (const electionId in selectedCandidates) {
                const election = allElections.find(e => e.id == electionId);
                const candidate = selectedCandidates[electionId];

                if (election && candidate) {
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
                        <div class="summary-election">${election.titre}</div>
                        <div class="summary-candidate">
                            <img src="${candidate.photoUrl || '/assets/images/default-avatar.png'}" 
                                 alt="${candidate.prenom} ${candidate.nom}" 
                                 class="summary-candidate-avatar"
                                 onerror="this.src='/assets/images/default-avatar.png'">
                            <span>${candidate.prenom} ${candidate.nom}</span>
                        </div>
                        <button class="summary-remove" data-election-id="${electionId}">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    `;

                    container.appendChild(summaryItem);
                }
            }

            // Ajouter les événements pour les boutons de suppression
            document.querySelectorAll('.summary-remove').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const electionId = this.dataset.electionId;
                    delete selectedCandidates[electionId];

                    // Désélectionner visuellement
                    document.querySelectorAll(`.candidate-card[data-election-id="${electionId}"]`).forEach(card => {
                        card.classList.remove('selected');
                    });

                    updateVoteSummary();
                });
            });

            submitBtn.disabled = false;
        }

        // Soumettre le vote
        async function submitVote() {
            const submitBtn = document.getElementById('submitVoteBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> En cours...';

            // Fermer le modal de confirmation
            document.getElementById('confirmationModal').classList.remove('active');

            try {
                let successCount = 0;

                for (const electionId in selectedCandidates) {
                    const candidate = selectedCandidates[electionId];

                    // Soumettre le vote
                    const result = await VoteService.submitVote({
                        electionId: parseInt(electionId),
                        candidateId: parseInt(candidate.id)
                    });

                    if (result.success) {
                        successCount++;
                    }
                }

                if (successCount > 0) {
                    // Afficher le modal de succès
                    document.getElementById('successModal').classList.add('active');
                    // Réinitialiser la sélection
                    resetVote();
                } else {
                    throw new Error('Aucun vote n\'a pu être enregistré');
                }

            } catch (error) {
                console.error('Erreur lors du vote:', error);
                showToast(error.message || 'Une erreur est survenue lors de l\'enregistrement de votre vote', 'error');

                // Réactiver le bouton
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Soumettre mon vote';
            }
        }

        // Réinitialiser le vote
        function resetVote() {
            selectedCandidates = {};
            selectedElection = null;

            // Mettre à jour l'interface
            document.querySelectorAll('.election-card, .candidate-card').forEach(item => {
                item.classList.remove('selected');
            });

            // Réinitialiser la section candidats
            document.getElementById('candidatesSection').innerHTML = `
                <div class="no-election-selected">
                    <i class="fa-solid fa-hand-pointer"></i>
                    <p>Sélectionnez une élection pour voir les candidats</p>
                </div>
            `;

            updateVoteSummary();
        }

        // Afficher une erreur pour les élections
        function showElectionsError(message) {
            const container = document.getElementById('electionsList');
            if (!container) return;

            container.innerHTML = `
                <div class="no-data-message">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <h3>${message}</h3>
                    <button class="btn btn-primary" onclick="loadPageData()">
                        <i class="fa-solid fa-refresh"></i>
                        Réessayer
                    </button>
                </div>
            `;
        }

        // Initialiser les gestionnaires d'événements
        function initEventHandlers() {
            // Gestionnaire de soumission de vote
            document.getElementById('submitVoteBtn').addEventListener('click', function () {
                if (Object.keys(selectedCandidates).length === 0) return;

                // Afficher le modal de confirmation
                document.getElementById('confirmationModal').classList.add('active');

                // Mettre à jour le texte de confirmation
                const electionCount = Object.keys(selectedCandidates).length;
                document.getElementById('confirmationText').textContent =
                    `Êtes-vous sûr de vouloir soumettre votre vote pour ${electionCount} élection(s)? Cette action est irréversible.`;
            });

            // Gestionnaire de réinitialisation
            document.getElementById('resetVoteBtn').addEventListener('click', resetVote);

            // Gestionnaire de confirmation de vote
            document.getElementById('confirmVoteBtn').addEventListener('click', submitVote);

            // Gestionnaire d'annulation de vote
            document.getElementById('cancelVoteBtn').addEventListener('click', function () {
                document.getElementById('confirmationModal').classList.remove('active');
            });

            // Gestionnaire de fermeture de modal
            document.getElementById('closeModal').addEventListener('click', function () {
                document.getElementById('confirmationModal').classList.remove('active');
            });

            document.getElementById('closeSuccessModal').addEventListener('click', function () {
                document.getElementById('successModal').classList.remove('active');
            });

            // Gestionnaire de retour aux élections
            document.getElementById('backToElectionsBtn').addEventListener('click', function () {
                document.getElementById('successModal').classList.remove('active');
                // Recharger la page pour actualiser les données
                location.reload();
            });
        }

        // Fonctions utilitaires
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            if (toast && toastIcon && toastMessage) {
                toastMessage.textContent = message;

                // Changer l'icône selon le type
                if (type === 'error') {
                    toastIcon.className = 'fa-solid fa-circle-exclamation';
                    toast.style.backgroundColor = '#f44336';
                } else if (type === 'warning') {
                    toastIcon.className = 'fa-solid fa-triangle-exclamation';
                    toast.style.backgroundColor = '#ff9800';
                } else {
                    toastIcon.className = 'fa-solid fa-circle-check';
                    toast.style.backgroundColor = '#4CAF50';
                }

                toast.classList.add('show');

                // Cacher après 3 secondes
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // Exposer les fonctions globales pour cette page
        window.loadPageData = loadPageData;
    </script>
</body>

</html>