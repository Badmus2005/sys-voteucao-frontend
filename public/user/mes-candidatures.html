<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Candidatures - UCAO-UUC</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles CSS -->
    <link rel="stylesheet" href="../assets/css/components/election-card.css">
    <link rel="stylesheet" href="../assets/css/pages/mes-candidatures.css">
</head>

<body>
    <header>
        <div class="logo"><i class="fa-solid fa-graduation-cap"></i> UCAO-UUC</div>
        <div class="user-nav">
            <span><i class="fa-solid fa-user"></i> <span id="userName">Étudiant</span></span>
            <a href="/user/profile"><i class="fa-solid fa-user"></i> Profil</a>
            <a href="#" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Déconnexion</a>
        </div>
        <div class="burger" id="burger">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </header>

    <div class="overlay" id="overlay"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li><a href="/user/dashboard.html"><i class="fa-solid fa-house"></i> Accueil</a></li>
                <li><a href="/user/candidature"><i class="fa-solid fa-file-signature"></i> Candidature</a></li>
                <li><a href="/user/elections"><i class="fa-solid fa-list"></i> Élections</a></li>
                <li><a href="/user/mes-candidatures" class="active"><i class="fa-solid fa-list"></i> Mes
                        Candidatures</a></li>
                <li><a href="/user/vote"><i class="fa-solid fa-check"></i> Voter</a></li>
                <li><a href="/user/resultats"><i class="fa-solid fa-chart-bar"></i> Résultats</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="dashboard.html"><i class="fa-solid fa-house"></i> Accueil</a>
                <i class="fa-solid fa-chevron-right"></i>
                <span>Mes Candidatures</span>
            </div>

            <!-- Filters -->
            <div class="filters">
                <h3 class="filters-title"><i class="fa-solid fa-filter"></i> Filtres</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Statut</label>
                        <select class="filter-select" id="filterStatus">
                            <option value="all">Tous les statuts</option>
                            <option value="en_attente">En attente</option>
                            <option value="approuve">Approuvé</option>
                            <option value="rejete">Rejeté</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Type d'élection</label>
                        <select class="filter-select" id="filterType">
                            <option value="all">Tous les types</option>
                            <option value="SALLE">Responsable de Salle</option>
                            <option value="ECOLE">Délégué d'École</option>
                            <option value="UNIVERSITE">Délégué d'Université</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Candidatures List -->
            <div class="candidatures-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fa-solid fa-file-signature"></i>
                        Mes candidatures
                    </h2>
                    <button class="btn btn-primary" id="newCandidatureBtn">
                        <i class="fa-solid fa-plus"></i>
                        Nouvelle candidature
                    </button>
                </div>

                <div class="candidatures-list" id="candidaturesList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement de vos candidatures...</p>
                    </div>
                </div>

                <div class="no-candidatures" id="noCandidaturesMessage">
                    <i class="fa-solid fa-file-circle-question"></i>
                    <h3>Aucune candidature</h3>
                    <p>Vous n'avez soumis aucune candidature pour le moment.</p>
                    <a href="candidature.html" class="btn btn-primary">
                        <i class="fa-solid fa-file-signature"></i>
                        Déposer une candidature
                    </a>
                </div>
            </div>

            <!-- Statistics -->
            <div class="stats-section">
                <h2 class="section-title"><i class="fa-solid fa-chart-pie"></i> Statistiques des candidatures</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon status-en_attente">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div class="stat-value" id="statEnAttente">0</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon status-approuve">
                            <i class="fa-solid fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="statApprouve">0</div>
                        <div class="stat-label">Approuvées</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon status-rejete">
                            <i class="fa-solid fa-times-circle"></i>
                        </div>
                        <div class="stat-value" id="statRejete">0</div>
                        <div class="stat-label">Rejetées</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fa-solid fa-file-signature"></i>
                        </div>
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Candidature Details Modal -->
    <div class="modal-overlay" id="candidatureModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Détails de la candidature</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="candidatureDetails">
                    <!-- Contenu chargé dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <i class="fa-solid fa-circle-check" id="toastIcon"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- Chargement des scripts -->
    <script src="../config.js"></script>
    <script src="../assets/js/utils/api.js"></script>
    <script src="../assets/js/services/electionService.js"></script>
    <script src="../assets/js/services/candidateService.js"></script>
    <script src="../assets/js/main.js"></script>

    <script>
        // Variables globales pour cette page
        let allCandidatures = [];
        let filteredCandidatures = [];
        let candidatureStats = {
            en_attente: 0,
            approuve: 0,
            rejete: 0,
            total: 0
        };

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', async function () {
            // Vérifier que l'utilisateur est connecté
            if (!localStorage.getItem('token')) {
                window.location.href = '/user/login';
                return;
            }

            // Initialiser les gestionnaires d'événements
            initEventHandlers();

            // Charger les données
            await loadPageData();
        });

        // Chargement des données de la page
        async function loadPageData() {
            showLoading();

            try {
                // Charger les candidatures de l'utilisateur
                await loadUserCandidatures();

            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                showToast('Erreur de chargement des données', 'error');
            } finally {
                hideLoading();
            }
        }

        // Charger les candidatures de l'utilisateur
        async function loadUserCandidatures() {
            try {
                // Cette endpoint devra être créé côté backend
                // Pour l'instant, nous allons simuler des données
                const simulatedCandidatures = await simulateCandidaturesData();

                if (simulatedCandidatures && simulatedCandidatures.length > 0) {
                    allCandidatures = simulatedCandidatures;
                    filteredCandidatures = [...allCandidatures];

                    displayCandidatures(filteredCandidatures);
                    calculateStatistics();
                    updateStatisticsDisplay();

                    document.getElementById('noCandidaturesMessage').style.display = 'none';
                } else {
                    showNoCandidatures();
                }
            } catch (error) {
                console.error('Erreur chargement candidatures:', error);
                showNoCandidatures();
            }
        }

        // Simuler des données de candidatures (à remplacer par un appel API réel)
        async function simulateCandidaturesData() {
            // Simuler un délai de chargement
            await new Promise(resolve => setTimeout(resolve, 1000));

            return [
                {
                    id: 1,
                    election: {
                        id: 101,
                        titre: "Président des étudiants",
                        type: "UNIVERSITE",
                        ecole: "UCAO",
                        dateDebut: "2024-01-15",
                        dateFin: "2024-01-20"
                    },
                    slogan: "Unis pour un campus meilleur",
                    statut: "approuve",
                    dateSoumission: "2024-01-10",
                    photoUrl: "https://via.placeholder.com/150",
                    programme: "Je m'engage à représenter fidèlement les intérêts des étudiants, à améliorer la vie sur le campus, et à faciliter le dialogue entre l'administration et les étudiants.",
                    motivation: "Passionné par la vie étudiante et ayant déjà une expérience en représentation, je souhaite mettre mes compétences au service de tous les étudiants."
                },
                {
                    id: 2,
                    election: {
                        id: 102,
                        titre: "Délégué de classe L2 Informatique",
                        type: "SALLE",
                        ecole: "EGEI",
                        filiere: "Informatique",
                        annee: "2",
                        dateDebut: "2024-02-01",
                        dateFin: "2024-02-05"
                    },
                    slogan: "L'excellence au service de tous",
                    statut: "en_attente",
                    dateSoumission: "2024-01-25",
                    photoUrl: "https://via.placeholder.com/150",
                    programme: "Organisation de séances de révision, création d'un système d'entraide entre étudiants, amélioration de la communication avec les professeurs.",
                    motivation: "Je souhaite contribuer à l'amélioration des conditions d'étude de ma promotion et représenter mes camarades auprès de l'administration."
                },
                {
                    id: 3,
                    election: {
                        id: 103,
                        titre: "Trésorier du BDE",
                        type: "ECOLE",
                        ecole: "ESMEA",
                        dateDebut: "2023-11-10",
                        dateFin: "2023-11-15"
                    },
                    slogan: "Transparence et efficacité",
                    statut: "rejete",
                    dateSoumission: "2023-11-05",
                    photoUrl: "https://via.placeholder.com/150",
                    programme: "Gestion transparente du budget, organisation d'événements financièrement accessibles, compte-rendu régulier des dépenses.",
                    motivation: "Avec mon expérience en gestion et mon souci du détail, je serai un trésorier rigoureux et transparent."
                }
            ];
        }

        // Afficher les candidatures
        function displayCandidatures(candidatures) {
            const container = document.getElementById('candidaturesList');
            if (!container) return;

            container.innerHTML = candidatures.map(candidature => `
                <div class="candidature-card" data-candidature-id="${candidature.id}">
                    <div class="candidature-header">
                        <div class="candidature-info">
                            <h3 class="candidature-title">${candidature.election.titre}</h3>
                            <span class="election-type">${ElectionService.getElectionTypeLabel(candidature.election.type)}</span>
                        </div>
                        <span class="candidature-status status-${candidature.statut}">
                            ${getStatusText(candidature.statut)}
                        </span>
                    </div>
                    
                    <div class="candidature-meta">
                        <div class="meta-item">
                            <i class="fa-solid fa-graduation-cap"></i>
                            <strong>École:</strong> ${candidature.election.ecole || 'Non spécifié'}
                        </div>
                        ${candidature.election.filiere ? `
                        <div class="meta-item">
                            <i class="fa-solid fa-layer-group"></i>
                            <strong>Filière:</strong> ${candidature.election.filiere}
                        </div>
                        ` : ''}
                        ${candidature.election.annee ? `
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar"></i>
                            <strong>Année:</strong> ${candidature.election.annee}
                        </div>
                        ` : ''}
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar-days"></i>
                            <strong>Soumis le:</strong> ${formatDate(candidature.dateSoumission)}
                        </div>
                    </div>
                    
                    ${candidature.slogan ? `
                    <div class="candidature-slogan">
                        <i class="fa-solid fa-quote-left"></i>
                        "${candidature.slogan}"
                    </div>
                    ` : ''}
                    
                    <div class="candidature-actions">
                        <button class="btn btn-secondary view-details-btn" data-candidature-id="${candidature.id}">
                            <i class="fa-solid fa-eye"></i>
                            Voir détails
                        </button>
                        
                        ${candidature.statut === 'en_attente' ? `
                        <button class="btn btn-warning edit-btn" data-candidature-id="${candidature.id}">
                            <i class="fa-solid fa-pen-to-square"></i>
                            Modifier
                        </button>
                        ` : ''}
                        
                        ${candidature.statut === 'en_attente' ? `
                        <button class="btn btn-danger cancel-btn" data-candidature-id="${candidature.id}">
                            <i class="fa-solid fa-trash"></i>
                            Annuler
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Ajouter les événements
            attachCandidatureEvents();
        }

        // Obtenir le texte du statut
        function getStatusText(status) {
            const statuses = {
                'en_attente': 'En attente',
                'approuve': 'Approuvé',
                'rejete': 'Rejeté'
            };
            return statuses[status] || status;
        }

        // Calculer les statistiques
        function calculateStatistics() {
            candidatureStats = {
                en_attente: allCandidatures.filter(c => c.statut === 'en_attente').length,
                approuve: allCandidatures.filter(c => c.statut === 'approuve').length,
                rejete: allCandidatures.filter(c => c.statut === 'rejete').length,
                total: allCandidatures.length
            };
        }

        // Mettre à jour l'affichage des statistiques
        function updateStatisticsDisplay() {
            document.getElementById('statEnAttente').textContent = candidatureStats.en_attente;
            document.getElementById('statApprouve').textContent = candidatureStats.approuve;
            document.getElementById('statRejete').textContent = candidatureStats.rejete;
            document.getElementById('statTotal').textContent = candidatureStats.total;
        }

        // Afficher le message d'absence de candidatures
        function showNoCandidatures() {
            document.getElementById('candidaturesList').innerHTML = '';
            document.getElementById('noCandidaturesMessage').style.display = 'block';

            // Réinitialiser les statistiques
            document.getElementById('statEnAttente').textContent = '0';
            document.getElementById('statApprouve').textContent = '0';
            document.getElementById('statRejete').textContent = '0';
            document.getElementById('statTotal').textContent = '0';
        }

        // Attacher les événements aux candidatures
        function attachCandidatureEvents() {
            // Boutons de détails
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const candidatureId = this.dataset.candidatureId;
                    const candidature = allCandidatures.find(c => c.id == candidatureId);

                    if (candidature) {
                        showCandidatureDetails(candidature);
                    }
                });
            });

            // Boutons de modification
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const candidatureId = this.dataset.candidatureId;
                    // Rediriger vers la page de modification
                    window.location.href = `candidature.html?edit=${candidatureId}`;
                });
            });

            // Boutons d'annulation
            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const candidatureId = this.dataset.candidatureId;

                    if (confirm('Êtes-vous sûr de vouloir annuler cette candidature ?')) {
                        await cancelCandidature(candidatureId);
                    }
                });
            });

            // Clic sur toute la carte
            document.querySelectorAll('.candidature-card').forEach(card => {
                card.addEventListener('click', function () {
                    const candidatureId = this.dataset.candidatureId;
                    const candidature = allCandidatures.find(c => c.id == candidatureId);

                    if (candidature) {
                        showCandidatureDetails(candidature);
                    }
                });
            });
        }

        // Afficher les détails d'une candidature
        function showCandidatureDetails(candidature) {
            const modal = document.getElementById('candidatureModal');
            const content = document.getElementById('candidatureDetails');

            if (!modal || !content) return;

            content.innerHTML = `
                <div class="candidature-detail-header">
                    <div class="candidature-detail-title">
                        <h3>${candidature.election.titre}</h3>
                        <span class="election-type">${ElectionService.getElectionTypeLabel(candidature.election.type)}</span>
                    </div>
                    <span class="candidature-status status-${candidature.statut}">
                        ${getStatusText(candidature.statut)}
                    </span>
                </div>

                <div class="candidature-detail-meta">
                    <div class="detail-meta-grid">
                        <div class="meta-item">
                            <i class="fa-solid fa-graduation-cap"></i>
                            <strong>École:</strong> ${candidature.election.ecole || 'Non spécifié'}
                        </div>
                        ${candidature.election.filiere ? `
                        <div class="meta-item">
                            <i class="fa-solid fa-layer-group"></i>
                            <strong>Filière:</strong> ${candidature.election.filiere}
                        </div>
                        ` : ''}
                        ${candidature.election.annee ? `
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar"></i>
                            <strong>Année:</strong> ${candidature.election.annee}
                        </div>
                        ` : ''}
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar-days"></i>
                            <strong>Période électorale:</strong> 
                            ${formatDate(candidature.election.dateDebut)} - ${formatDate(candidature.election.dateFin)}
                        </div>
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar-check"></i>
                            <strong>Soumis le:</strong> ${formatDate(candidature.dateSoumission)}
                        </div>
                    </div>
                </div>

                ${candidature.slogan ? `
                <div class="candidature-detail-slogan">
                    <h4><i class="fa-solid fa-quote-left"></i> Slogan de campagne</h4>
                    <p>"${candidature.slogan}"</p>
                </div>
                ` : ''}

                <div class="candidature-detail-section">
                    <h4><i class="fa-solid fa-book"></i> Programme électoral</h4>
                    <div class="detail-content">
                        <p>${candidature.programme || 'Aucun programme disponible'}</p>
                    </div>
                </div>

                <div class="candidature-detail-section">
                    <h4><i class="fa-solid fa-heart"></i> Lettre de motivation</h4>
                    <div class="detail-content">
                        <p>${candidature.motivation || 'Aucune motivation disponible'}</p>
                    </div>
                </div>

                ${candidature.statut === 'rejete' ? `
                <div class="candidature-detail-section">
                    <h4><i class="fa-solid fa-info-circle"></i> Informations</h4>
                    <div class="detail-content">
                        <p class="status-info">Votre candidature a été rejetée par l'administration. 
                        Vous pouvez contacter le service des élections pour plus d'informations.</p>
                    </div>
                </div>
                ` : ''}

                ${candidature.statut === 'en_attente' ? `
                <div class="candidature-actions-modal">
                    <button class="btn btn-warning" onclick="window.location.href='candidature.html?edit=${candidature.id}'">
                        <i class="fa-solid fa-pen-to-square"></i>
                        Modifier la candidature
                    </button>
                    <button class="btn btn-danger" onclick="cancelCandidature(${candidature.id})">
                        <i class="fa-solid fa-trash"></i>
                        Annuler la candidature
                    </button>
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        // Annuler une candidature
        async function cancelCandidature(candidatureId) {
            showLoading();

            try {
                // Simuler l'annulation (à remplacer par un appel API réel)
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Mettre à jour localement
                allCandidatures = allCandidatures.filter(c => c.id != candidatureId);
                filteredCandidatures = [...allCandidatures];

                displayCandidatures(filteredCandidatures);
                calculateStatistics();
                updateStatisticsDisplay();

                // Fermer la modale si ouverte
                document.getElementById('candidatureModal').classList.remove('active');

                showToast('Candidature annulée avec succès', 'success');

            } catch (error) {
                console.error('Erreur annulation candidature:', error);
                showToast('Erreur lors de l\'annulation', 'error');
            } finally {
                hideLoading();
            }
        }

        // Filtrer les candidatures
        function filterCandidatures() {
            const statusFilter = document.getElementById('filterStatus').value;
            const typeFilter = document.getElementById('filterType').value;

            filteredCandidatures = allCandidatures.filter(candidature => {
                // Filtre par statut
                if (statusFilter !== 'all' && candidature.statut !== statusFilter) {
                    return false;
                }

                // Filtre par type
                if (typeFilter !== 'all' && candidature.election.type !== typeFilter) {
                    return false;
                }

                return true;
            });

            displayCandidatures(filteredCandidatures);
        }

        // Initialiser les gestionnaires d'événements
        function initEventHandlers() {
            // Filtres
            document.getElementById('filterStatus').addEventListener('change', filterCandidatures);
            document.getElementById('filterType').addEventListener('change', filterCandidatures);

            // Nouvelle candidature
            document.getElementById('newCandidatureBtn').addEventListener('click', function () {
                window.location.href = 'candidature.html';
            });

            // Fermeture de la modale
            document.getElementById('closeModal').addEventListener('click', function () {
                document.getElementById('candidatureModal').classList.remove('active');
            });

            // Fermer la modale en cliquant à l'extérieur
            document.addEventListener('click', function (event) {
                const modal = document.getElementById('candidatureModal');
                if (modal && event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        }

        // Exposer les fonctions globales pour cette page
        window.cancelCandidature = cancelCandidature;
        window.loadPageData = loadPageData;
    </script>
</body>

</html>